(window.webpackJsonp=window.webpackJsonp||[]).push([[217],{366:function(t,s,e){"use strict";e.r(s);var a=e(42),n=Object(a.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"二进制安装k8s（未成功）"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二进制安装k8s（未成功）"}},[t._v("#")]),t._v(" 二进制安装k8s（未成功）")]),t._v(" "),e("h2",{attrs:{id:"一、初始化系统"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#一、初始化系统"}},[t._v("#")]),t._v(" 一、初始化系统")]),t._v(" "),e("h2",{attrs:{id:"二、初始化配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#二、初始化配置"}},[t._v("#")]),t._v(" 二、初始化配置")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("关防火墙")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("systemctl stop firewalld\nsystemctl disable firewalld\n")])])])]),t._v(" "),e("li",[e("p",[t._v("关闭selinux")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" -i "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'s/enforcing/disabled/'")]),t._v(" /etc/selinux/config\nsetenforce "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("关闭swap分区")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("swapoff -a\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" -ri "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'s/.*swap.*/#&/'")]),t._v(" /etc/fstab\n")])])])]),t._v(" "),e("li",[e("p",[t._v("根据规划设置主机名")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("hostnamectl set-hostname k8smaster\nhostnamectl set-hostname k8snode1\nhostnamectl set-hostname h8snode2\n")])])])]),t._v(" "),e("li",[e("p",[t._v("在master中添加host")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" /etc/hosts "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF\n192.168.76.5 master\n192.168.76.6 node1\n192.168.76.7 node2\nEOF")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("将桥接的IPV4流量传递到iptables的链")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /etc/sysctl.d/k8s.conf "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF\nnet.bridge.bridge-nf-call-ip6tables = 1\nnet.bridge.bridge-nf-call-iptables = 1\nEOF")]),t._v("\nsysctl --system\n")])])])]),t._v(" "),e("li",[e("p",[t._v("同步时间")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("yum -y "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" ntpdate \nntpdate time.windows.com\n")])])])]),t._v(" "),e("li")]),t._v(" "),e("h2",{attrs:{id:"三、为etcd和apiserver自签证书"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#三、为etcd和apiserver自签证书"}},[t._v("#")]),t._v(" 三、为etcd和apiserver自签证书")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("下载证书")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p /opt/module/cfssl\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /opt/module/cfssl\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://pkg.cfssl.org/R1.2/cfssl_linux-amd64\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("chmod")]),t._v(" +x cfssl_linux-amd64 cfssljson_linux-amd64 cfssl-certinfo_linux-amd64\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ln")]),t._v(" -s /opt/module/cfssl/cfssl_linux-amd64 /usr/local/bin/cfssl\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ln")]),t._v(" -s /opt/module/cfssl/cfssljson_linux-amd64 /usr/local/bin/cfssljson\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ln")]),t._v(" -s /opt/module/cfssl/cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo\n")])])])]),t._v(" "),e("li",[e("p",[t._v("生成Etcd证书")]),t._v(" "),e("ul",[e("li",[e("p",[t._v("自签证书颁发机构（CA）")]),t._v(" "),e("p",[t._v("创建目录")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p /opt/module/etcd\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p /opt/module/etcd/config\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p /opt/module/etcd/pem\n")])])])])]),t._v(" "),e("p",[t._v("cd /opt/module/etcd/config")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('\n自签CA：\n\n```json\ncat > ca-config.json<< EOF\n{\n    "signing": {\n        "default": {\n            "expiry": "87600h"\n        },\n        "profiles": {\n            "www": {\n                "expiry": "87600h",\n                "usages": [\n                    "signing",\n                    "key encipherment",\n                    "server auth",\n                    "client auth"\n                ]\n            }\n        }\n    }\n}\nEOF\n')])])]),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" ca-csr.json"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('EOF\n{\n    "CN": "etcd CA",\n    "key": {\n        "algo": "rsa",\n        "size": 2048\n    },\n    "names": [\n        {\n            "C": "CN",\n            "L": "Beijing",\n            "ST": "Beijing"\n        }\n    ]\n}\nEOF')]),t._v("\n")])])]),e("p",[t._v("生成证书：")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("cfssl gencert -initca ca-csr.json "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" cfssljson -bare ca -\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mv")]),t._v(" /opt/module/etcd/config/*.pem /opt/module/etcd/pem\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ls")]),t._v(" *pem\n")])])])])]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v(' \n\n \n+ 使用自签 CA 签发 Etcd HTTPS 证书\n \n   创建证书申请文件\n \n   ```json\n   cat > server-csr.json<< EOF\n   {\n       "CN": "etcd",\n       "hosts": [\n           "192.168.76.8",\n           "192.168.76.9",\n           "192.168.76.10"\n       ],\n       "key": {\n           "algo": "rsa",\n           "size": 2048\n       },\n       "names": [\n           {\n               "C": "CN",\n               "L": "BeiJing",\n               "ST": "BeiJing"\n           }\n       ]\n}\n   EOF\n')])])]),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[t._v(" 注意：上述文件 hosts 字段中 IP 为所有 etcd 节点的集群内部通信 IP，一个都不能少！为了\n")])])]),e("p",[t._v("方便后期扩容可以多写几个预留的 IP")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[t._v(" 生成证书：\n   \n ```bash\n cfssl gencert -ca=/opt/module/etcd/pem/ca.pem \\\n -ca-key=/opt/module/etcd/pem/ca-key.pem \\\n -config=/opt/module/etcd/config/ca-config.json \\\n -profile=www /opt/module/etcd/config/server-csr.json | cfssljson -bare server\n ```\n \n ```bash\n mv /opt/module/etcd/config/*.pem /opt/module/etcd/pem/\n ```\n")])])]),e("h2",{attrs:{id:"四、部署etcd"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#四、部署etcd"}},[t._v("#")]),t._v(" 四、部署etcd")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("下载")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("wget https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz\nwget https://g.ioiox.com/https://github.com/etcd-io/etcd/releases/download/v3.4.9/etcd-v3.4.9-linux-amd64.tar.gz\n")])])])]),t._v(" "),e("li",[e("p",[t._v("解压安装")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" zxvf /opt/software/etcd-v3.4.9-linux-amd64.tar.gz -C /opt/module\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mv")]),t._v(" /opt/module/etcd-v3.4.9-linux-amd64/* /opt/module/etcd\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -rf /opt/module/etcd-v3.4.9-linux-amd64\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /opt/module/etcd/bin\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mv")]),t._v(" /opt/module/etcd/etcd /opt/module/etcd/bin\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mv")]),t._v(" /opt/module/etcd/disabletl /opt/module/etcd/bin\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ln")]),t._v(" -s /opt/module/etcd/bin/etcd /usr/local/bin/etcd\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ln")]),t._v(" -s /opt/module/etcd//bin/disabletl /usr/local/bin/etcdctl\n")])])])]),t._v(" "),e("li",[e("p",[t._v("创建etcd配置文件")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /opt/module/etcd/config/etcd.conf "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('EOF\n#[Member]\nETCD_NAME="etcd-1"\nETCD_DATA_DIR="/var/lib/etcd/default.etcd"\nETCD_LISTEN_PEER_URLS="https://192.168.76.8:2380"\nETCD_LISTEN_CLIENT_URLS="https://192.168.76.8:2379"\n#[Clustering]\nETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.76.8:2380"\nETCD_ADVERTISE_CLIENT_URLS="https://192.168.76.8:2379"\nETCD_INITIAL_CLUSTER="etcd-1=https://192.168.76.8:2380,etcd-2=https://192.168.76.9:2380,etcd-3=https://192.168.76.10:2380"\nETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"\nETCD_INITIAL_CLUSTER_STATE="new"\nEOF')]),t._v("\n")])])])])]),t._v(" "),e("p",[t._v("解释：")]),t._v(" "),e("blockquote",[e("p",[t._v("ETCD_NAME：节点名称，集群中唯一\nETCD_DATA_DIR：数据目录\nETCD_LISTEN_PEER_URLS：集群通信监听地址\nETCD_LISTEN_CLIENT_URLS：客户端访问监听地址\nETCD_INITIAL_ADVERTISE_PEER_URLS：集群通告地址\nETCD_ADVERTISE_CLIENT_URLS：客户端通告地址\nETCD_INITIAL_CLUSTER：集群节点地址\nETCD_INITIAL_CLUSTER_TOKEN：集群 Token\nETCD_INITIAL_CLUSTER_STATE：加入集群的当前状态，new 是新集群，existing 表示加入\n已有集群")])]),t._v(" "),e("ol",{attrs:{start:"4"}},[e("li",[e("p",[t._v("systemd 管理 etcd")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /usr/lib/systemd/system/etcd.service "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF\n[Unit]\nDescription=Etcd Server\nAfter=network.target\nAfter=network-online.target\nWants=network-online.target\n[Service]\nType=notify\nEnvironmentFile=/opt/module/etcd/config/etcd.conf\nExecStart=/opt/module/etcd/bin/etcd \\\n--cert-file=/opt/module/etcd/pem/server.pem \\\n--key-file=/opt/module/etcd/pem/server-key.pem \\\n--peer-cert-file=/opt/module/etcd/pem/server.pem \\\n--peer-key-file=/opt/module/etcd/pem/server-key.pem \\\n--trusted-ca-file=/opt/module/etcd/pem/ca.pem \\\n--peer-trusted-ca-file=/opt/module/etcd/pem/ca.pem \\\n--logger=zap\nRestart=on-failure\nLimitNOFILE=65536\n[Install]\nWantedBy=multi-user.target\nEOF")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("启动并设置开机启动")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("systemctl daemon-reload\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" etcd\nsystemctl start etcd\nsystemctl status etcd\n")])])])]),t._v(" "),e("li",[e("p",[t._v("在节点2与节点3部署etcd")])]),t._v(" "),e("li",[e("p",[t._v("然后在节点 2 和节点 3 分别修改 etcd.conf 配置文件中的节点名称和当前服务器 IP")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("vi")]),t._v(" /opt/module/etcd/config/etcd.conf\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#[Member]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCD_NAME")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"etcd-1"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改此处，节点 2 改为 etcd-2，节点 3 改为 etcd-3")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCD_DATA_DIR")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/var/lib/etcd/default.etcd"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCD_LISTEN_PEER_URLS")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://192.168.31.71:2380"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改此处为当前服务器 IP")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCD_LISTEN_CLIENT_URLS")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://192.168.31.71:2379"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改此处为当前服务器 IP")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#[Clustering]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCD_INITIAL_ADVERTISE_PEER_URLS")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://192.168.31.71:2380"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改此处为当前")]),t._v("\n服务器 IP\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCD_ADVERTISE_CLIENT_URLS")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://192.168.31.71:2379"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 修改此处为当前服务器")]),t._v("\nIP\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCD_INITIAL_CLUSTER")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"etcd-1=https://192.168.31.71:2380,etcd-2=https://192.168.31.72:2380,etcd-3=https://192.168.31.73:2380"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCD_INITIAL_CLUSTER_TOKEN")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"etcd-cluster"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCD_INITIAL_CLUSTER_STATE")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"new"')]),t._v("\n")])])]),e("p",[t._v("最后启动 etcd 并设置开机启动，同上")])]),t._v(" "),e("li",[e("p",[t._v("查看集群状态")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ETCDCTL_API")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),t._v(" /opt/module/etcd/bin/etcdctl --cacert"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/opt/module/etcd/pem/ca.pem --cert"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/opt/module/etcd/pem/server.pem --key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/opt/module/etcd/pem/server-key.pem --endpoints"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"https://192.168.76.8:2379,https://192.168.76.9:2379,https://192.168.76.10:2379"')]),t._v(" endpoint health\nhttps://192.168.31.71:2379 is healthy: successfully committed proposal: took "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("8")]),t._v(".154404ms\nhttps://192.168.31.73:2379 is healthy: successfully committed proposal: took "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("9")]),t._v(".044117ms\nhttps://192.168.31.72:2379 is healthy: successfully committed proposal: took "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),t._v(".000825ms\n")])])]),e("p",[t._v("如果输出上面信息，就说明集群部署成功。如果有问题第一步先看日志：/var/log/message 或 journalctl -u etcd")])])]),t._v(" "),e("h2",{attrs:{id:"五、安装docker"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#五、安装docker"}},[t._v("#")]),t._v(" 五、安装Docker")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("下载")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://download.docker.com/linux/static/stable/x86_64/docker-19.03.9.tgz\n")])])])]),t._v(" "),e("li",[e("p",[t._v("解压安装")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" -zxvf /opt/software/docker-19.03.9.tgz -C /opt/module/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ln")]),t._v(" -s /opt/module/docker/containerd /usr/local/bin/containerd\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ln")]),t._v(" -s /opt/module/docker/containerd-shim /usr/local/bin/containerd-shim\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ln")]),t._v(" -s /opt/module/docker/ctr /usr/local/bin/ctr\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ln")]),t._v(" -s /opt/module/docker/docker /usr/local/bin/docker\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ln")]),t._v(" -s /opt/module/docker/dockerd /usr/local/bin/dockerd\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ln")]),t._v(" -s /opt/module/docker/docker-init /usr/local/bin/docker-init\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ln")]),t._v(" -s /opt/module/docker/docker-proxy /usr/local/bin/docker-proxy\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ln")]),t._v(" -s /opt/module/docker/runc /usr/local/bin/runc\n")])])])]),t._v(" "),e("li",[e("p",[t._v("注册为系统服务")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /usr/lib/systemd/system/docker.service "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF\n[Unit]\nDescription=Docker Application Container Engine\nDocumentation=https://docs.docker.com\nAfter=network-online.target firewalld.service\nWants=network-online.target\n[Service]\nType=notify\nExecStart=/usr/local/bin/dockerd\nExecReload=/bin/kill -s HUP "),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$MAINPID")]),t._v("\nLimitNOFILE=infinity\nLimitNPROC=infinity\nLimitCORE=infinity\nTimeoutStartSec=0\nDelegate=yes\nKillMode=process\nRestart=on-failure\nStartLimitBurst=3\nStartLimitInterval=60s\n[Install]\nWantedBy=multi-user.target\nEOF")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("创建配置文件")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /etc/docker\n")])])]),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /etc/docker/daemon.json "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('EOF\n{\n"registry-mirrors": ["https://im0s841i.mirror.aliyuncs.com"]\n}\nEOF')]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("启动并设置开机启动")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("systemctl daemon-reload\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" docker\nsystemctl start docker\nsystemctl status docker\n")])])])])]),t._v(" "),e("h2",{attrs:{id:"六、部署master组件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#六、部署master组件"}},[t._v("#")]),t._v(" 六、部署master组件")]),t._v(" "),e("h3",{attrs:{id:"_6-1-生成-kube-apiserver-证书"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-1-生成-kube-apiserver-证书"}},[t._v("#")]),t._v(" 6.1 生成 kube-apiserver 证书")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("自签证书颁发机构（CA）")]),t._v(" "),e("p",[t._v("创建目录")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /opt/module/kubernetes\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /opt/module/kubernetes/config\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" /opt/module/kubernetes/pem\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /opt/module/kubernetes/config\n")])])]),e("p",[t._v("自签CA：")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[t._v("cat > /opt/module/kubernetes/config/ca-config.json<< EOF\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"signing"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"default"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"expiry"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"87600h"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"profiles"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"kubernetes"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"expiry"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"87600h"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"usages"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" \n                    "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"signing"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                    "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"key encipherment"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                    "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"server auth"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                    "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"client auth"')]),t._v("\n                "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nEOF\n")])])]),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[t._v("cat > ca-csr.json<< EOF\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"CN"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kubernetes"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"key"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"algo"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"rsa"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"size"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2048")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"names"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"C"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"CN"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"L"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Beijing"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"ST"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Beijing"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"O"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"k8s"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"OU"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"System"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nEOF\n")])])])]),t._v(" "),e("li",[e("p",[t._v("生成证书")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("cfssl gencert -initca /opt/module/kubernetes/config/ca-csr.json "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" cfssljson -bare ca -\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mv")]),t._v(" /opt/module/kubernetes/config/*.pem /opt/module/kubernetes/pem/\n")])])])]),t._v(" "),e("li",[e("p",[t._v("使用自签 CA 签发 kube-apiserver HTTPS 证书")]),t._v(" "),e("p",[t._v("创建证书申请文件：")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /opt/module/kubernetes/config\n")])])]),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[t._v("cat > /opt/module/kubernetes/config/server-csr.json<< EOF\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"CN"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kubernetes"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"hosts"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"10.0.0.1"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"127.0.0.1"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"192.168.76.8"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"192.168.76.9"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"192.168.76.10"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"192.168.76.11"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"192.168.76.12"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"192.168.76.13"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"192.168.76.14"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kubernetes"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kubernetes.default"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kubernetes.default.svc"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kubernetes.default.svc.cluster"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"kubernetes.default.svc.cluster.local"')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"key"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"algo"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"rsa"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"size"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2048")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"names"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"C"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"CN"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"L"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"BeiJing"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"ST"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"BeiJing"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"O"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"k8s"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"OU"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"System"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nEOF\n")])])]),e("p",[t._v("生成证书:")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("cfssl gencert -ca"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/opt/module/kubernetes/pem/ca.pem "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-ca-key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/opt/module/kubernetes/pem/ca-key.pem "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-config"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/opt/module/kubernetes/config/ca-config.json "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-profile"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("kubernetes /opt/module/kubernetes/config/server-csr.json "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" cfssljson -bare server\n")])])]),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mv")]),t._v(" /opt/module/kubernetes/config/*.pem /opt/module/kubernetes/pem/\n")])])])])]),t._v(" "),e("h3",{attrs:{id:"_6-2-部署-kube-apiserver"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-2-部署-kube-apiserver"}},[t._v("#")]),t._v(" 6.2 部署 kube-apiserver")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("下载kubernetes-server-linux-amd64.tar.gz")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://g.ioiox.com/https://dl.k8s.io/v1.18.10/kubernetes-server-linux-amd64.tar.gz\n")])])])]),t._v(" "),e("li",[e("p",[t._v("解压")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" -zxvf /opt/software/kubernetes-server-linux-amd64.tar.gz -C /opt/module/\n")])])]),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mv")]),t._v(" /opt/module/kubernetes/server/bin /opt/module/kubernetes\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("ln")]),t._v(" -s /opt/module/kubernetes/bin/kubectl /usr/local/bin/kubectl\n")])])])]),t._v(" "),e("li",[e("p",[t._v("创建文件夹")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" -p /opt/module/kubernetes/logs\n")])])])]),t._v(" "),e("li",[e("p",[t._v("启用 TLS Bootstrapping 机制")]),t._v(" "),e("p",[t._v("TLS Bootstraping：Master apiserver 启用 TLS 认证后，Node 节点 kubelet 和 kube-proxy 要与 kube-apiserver 进行通信，必须使用 CA 签发的有效证书才可以，当 Node节点很多时，这种客户端证书颁发需要大量工作，同样也会增加集群扩展复杂度。为了简化流程，Kubernetes 引入了 TLS bootstraping 机制来自动颁发客户端证书，kubelet会以一个低权限用户自动向 apiserver 申请证书，kubelet 的证书由piserver 动态签署。所以强烈建议在 Node 上使用这种方式，目前主要用于 kubelet，kube-proxy 还是由我们统一颁发一个证书。")])]),t._v(" "),e("li",[e("p",[t._v("创建上述配置文件中 token 文件")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /opt/module/kubernetes/config/token.csv "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('EOF\nc47ffb939f5ca36231d9e3121a252940,kubelet-bootstrap,10001,"system:kubelet-bootstrap"\nEOF')]),t._v("\n")])])]),e("p",[t._v("格式：token，用户名，UID，用户组")]),t._v(" "),e("p",[t._v("生成token命令：")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("head")]),t._v(" -c "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("16")]),t._v(" /dev/urandom "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" od -An -t x "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("tr")]),t._v(" -d "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("' '")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("创建配置文件")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /opt/module/kubernetes/config/kube-apiserver.conf "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('EOF\nKUBE_APISERVER_OPTS="--logtostderr=false '),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--v=2 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--log-dir=/opt/module/kubernetes/logs "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--etcd-servers=https://192.168.76.8:2379,https://192.168.76.9:2379,https://192.168.76.10:2379 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--bind-address=192.168.76.8 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--secure-port=6443 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--advertise-address=192.168.76.8 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--allow-privileged=true "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--service-cluster-ip-range=10.0.0.0/24 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,ResourceQuota,NodeRestriction "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--authorization-mode=RBAC,Node "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--enable-bootstrap-token-auth=true "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--token-auth-file=/opt/module/kubernetes/config/token.csv "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--service-node-port-range=30000-32767 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--kubelet-client-certificate=/opt/module/kubernetes/pem/server.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--kubelet-client-key=/opt/module/kubernetes/pem/server-key.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--tls-cert-file=/opt/module/kubernetes/pem/server.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--tls-private-key-file=/opt/module/kubernetes/pem/server-key.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--client-ca-file=/opt/module/kubernetes/pem/ca.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--service-account-key-file=/opt/module/kubernetes/pem/ca-key.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--etcd-cafile=/opt/module/etcd/pem/ca.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--etcd-certfile=/opt/module/etcd/pem/server.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--etcd-keyfile=/opt/module/etcd/pem/server-key.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--audit-log-maxage=30 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--audit-log-maxbackup=3 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--audit-log-maxsize=100 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v('\n--audit-log-path=/opt/module/kubernetes/logs/k8s-audit.log"\nEOF')]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("将apiserver注册为系统服务")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /usr/lib/systemd/system/kube-apiserver.service "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF\n[Unit]\nDescription=Kubernetes API Server\nDocumentation=https://github.com/kubernetes/kubernetes\n[Service]\nEnvironmentFile=/opt/module/kubernetes/config/kube-apiserver.conf\nExecStart=/opt/module/kubernetes/bin/kube-apiserver \\"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$KUBE_APISERVER_OPTS")]),t._v("\nRestart=on-failure\n[Install]\nWantedBy=multi-user.target\nEOF")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("启动并设置开机启动")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("systemctl daemon-reload\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" kube-apiserver\nsystemctl start kube-apiserver\nsystemctl status kube-apiserver\n")])])])]),t._v(" "),e("li",[e("p",[t._v("授权kubelet-bootstrap 用户允许请求证书")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl create clusterrolebinding kubelet-bootstrap "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--clusterrole"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("system:node-bootstrapper "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--user"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("kubelet-bootstrap\n")])])])])]),t._v(" "),e("h3",{attrs:{id:"_6-3-部署kube-controller"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-3-部署kube-controller"}},[t._v("#")]),t._v(" 6.3 部署kube-controller")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("创建配置文件")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /opt/module/kubernetes/config/kube-controller-manager.conf "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('EOF\nKUBE_CONTROLLER_MANAGER_OPTS="--logtostderr=false '),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--v=2 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--log-dir=/opt/module/kubernetes/logs "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--leader-elect=true "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--master=127.0.0.1:8080 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--bind-address=127.0.0.1 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--allocate-node-cidrs=true "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--cluster-cidr=10.244.0.0/16 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--service-cluster-ip-range=10.0.0.0/24 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--cluster-signing-cert-file=/opt/module/kubernetes/pem/ca.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--cluster-signing-key-file=/opt/module/kubernetes/pem/ca-key.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--root-ca-file=/opt/module/kubernetes/pem/ca.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--service-account-private-key-file=/opt/module/kubernetes/pem/ca-key.pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v('\n--experimental-cluster-signing-duration=87600h0m0s"\nEOF')]),t._v("\n")])])]),e("p",[t._v("说明：")]),t._v(" "),e("blockquote",[e("p",[t._v("–master：通过本地非安全本地端口 8080 连接 apiserver。\n–leader-elect：当该组件启动多个时，自动选举（HA）\n–cluster-signing-cert-file/–cluster-signing-key-file：自动为 kubelet 颁发证书\n的 CA，与 apiserver 保持一致")])]),t._v(" "),e("ol",{attrs:{start:"2"}},[e("li",[e("p",[t._v("注册为系统服务")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /usr/lib/systemd/system/kube-controller-manager.service "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF\n[Unit]\nDescription=Kubernetes Controller Manager\nDocumentation=https://github.com/kubernetes/kubernetes\n[Service]\nEnvironmentFile=/opt/module/kubernetes/config/kube-controller-manager.conf\nExecStart=/opt/module/kubernetes/bin/kube-controller-manager \\"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$KUBE_CONTROLLER_MANAGER_OPTS")]),t._v("\nRestart=on-failure\n[Install]\nWantedBy=multi-user.target\nEOF")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("设置开机启动并自启")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("systemctl daemon-reload\nsystemctl start kube-controller-manager\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" kube-controller-manager\nsystemctl status kube-controller-manager\n")])])])])])])]),t._v(" "),e("h3",{attrs:{id:"_6-4-部署kube-scheduler"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_6-4-部署kube-scheduler"}},[t._v("#")]),t._v(" 6.4 部署kube-scheduler")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("创建配置文件")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /opt/module/kubernetes/config/kube-scheduler.conf "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('EOF\nKUBE_SCHEDULER_OPTS="--logtostderr=false \\\n--v=2 \\\n--log-dir=/opt/module/kubernetes/logs \\\n--leader-elect \\\n--master=127.0.0.1:8080 \\\n--bind-address=127.0.0.1"\nEOF')]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("注册为系统服务")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /usr/lib/systemd/system/kube-scheduler.service "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF\n[Unit]\nDescription=Kubernetes Scheduler\nDocumentation=https://github.com/kubernetes/kubernetes\n[Service]\nEnvironmentFile=/opt/module/kubernetes/config/kube-scheduler.conf\nExecStart=/opt/module/kubernetes/bin/kube-scheduler \\"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$KUBE_SCHEDULER_OPTS")]),t._v("\nRestart=on-failure\n[Install]\nWantedBy=multi-user.target\nEOF")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("启动并设置开机启动")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("systemctl daemon-reload\nsystemctl start kube-scheduler\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" kube-scheduler\nsystemctl status kube-scheduler\n")])])])])]),t._v(" "),e("h2",{attrs:{id:"七、部署node组件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#七、部署node组件"}},[t._v("#")]),t._v(" 七、部署node组件")]),t._v(" "),e("h3",{attrs:{id:"_7-1-部署kubelet"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-1-部署kubelet"}},[t._v("#")]),t._v(" 7.1 部署kubelet")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("下载kubernetes-server-linux-amd64.tar.gz")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://g.ioiox.com/https://dl.k8s.io/v1.18.10/kubernetes-server-linux-amd64.tar.gz\n")])])])]),t._v(" "),e("li",[e("p",[t._v("解压")]),t._v(" "),e("p",[t._v("在主节点不需要此操作")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code")])])])]),t._v(" "),e("p",[t._v("tar -zxvf /opt/software/kubernetes-server-linux-amd64.tar.gz -C /opt/module/")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("\n3. 创建文件夹\n\n在主节点不需要此操作\n\n```bash\nmkdir -p /opt/module/kubernetes/{bin,cfg,ssl,logs}\n")])])]),e("ol",{attrs:{start:"4"}},[e("li",[e("p",[t._v("拷贝文件")]),t._v(" "),e("p",[t._v("在主节点不需要此操作")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" /opt/module/kubernetes/server/bin/kubelet /opt/module/kubernetes/bin/\n")])])])]),t._v(" "),e("li",[e("p",[t._v("创建配置文件")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /opt/module/kubernetes/config/kubelet.conf "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('EOF\nKUBELET_OPTS="--logtostderr=true '),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--v=2 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--log-dir=/opt/module/kubernetes/logs "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--hostname-override=node1 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--network-plugin=cni "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--kubeconfig=/opt/module/kubernetes/config/kubelet.kubeconfig "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--bootstrap-kubeconfig=/opt/module/kubernetes/config/bootstrap.kubeconfig "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--config=/opt/module/kubernetes/config/kubelet-config.yml "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--cert-dir=/opt/module/kubernetes/pem "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v('\n--pod-infra-container-image=lizhenliang/pause-amd64:3.0"\nEOF')]),t._v("\n")])])]),e("p",[t._v("参数解释：")]),t._v(" "),e("blockquote",[e("p",[t._v("–hostname-override：显示名称，集群中唯一\n–network-plugin：启用 CNI\n–kubeconfig：空路径，会自动生成，后面用于连接 apiserver\n–bootstrap-kubeconfig：首次启动向 apiserver 申请证书\n–config：配置参数文件\n–cert-dir：kubelet 证书生成目录\n–pod-infra-container-image：管理 Pod 网络容器的镜像")])])]),t._v(" "),e("li",[e("p",[t._v("配置参数文件")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[t._v("cat "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(" /opt/module/kubernetes/config/kubelet"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("config.yml << EOF\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" KubeletConfiguration\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kubelet.config.k8s.io/v1beta1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("address")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 0.0.0.0\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10250")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("readOnlyPort")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("10255")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cgroupDriver")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cgroupfs\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("clusterDNS")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" 10.0.0.2\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("clusterDomain")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cluster.local\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("failSwapOn")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("authentication")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("anonymous")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("enabled")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("false")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("webhook")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cacheTTL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 2m0s\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("enabled")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("x509")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("clientCAFile")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /opt/module/kubernetes/pem/ca.pem\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("authorization")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("mode")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Webhook\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("webhook")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cacheAuthorizedTTL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 5m0s\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cacheUnauthorizedTTL")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 30s\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("evictionHard")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("imagefs.available")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 15%\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("memory.available")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 100Mi\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodefs.available")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 10%\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodefs.inodesFree")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 5%\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("maxOpenFiles")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1000000")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("maxPods")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("110")]),t._v("\nEOF\n")])])])]),t._v(" "),e("li",[e("p",[t._v("生成bootstrap.kubeconfig文件")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl config set-cluster kubernetes "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--certificate-authority"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/opt/module/kubernetes/pem/ca.pem "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--embed-certs"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--server"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https://192.168.76.8:6443 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--kubeconfig"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("bootstrap.kubeconfig\n")])])]),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl config set-credentials kubelet-bootstrap "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--token"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("c47ffb939f5ca36231d9e3121a252940 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--kubeconfig"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("bootstrap.kubeconfig\n")])])]),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl config set-context default "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--cluster"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("kubernetes "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--user"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("kube-proxy "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--kubeconfig"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("bootstrap.kubeconfig\n")])])]),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl config use-context default "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--kubeconfig"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("bootstrap.kubeconfig\n")])])])]),t._v(" "),e("li",[e("p",[t._v("注册为系统服务")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /usr/lib/systemd/system/kubelet.service "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF\n[Unit]\nDescription=Kubernetes Kubelet\nAfter=docker.service\n[Service]\nEnvironmentFile=/opt/module/kubernetes/config/kubelet.conf\nExecStart=/opt/module/kubernetes/bin/kubelet \\"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$KUBELET_OPTS")]),t._v("\nRestart=on-failure\nLimitNOFILE=65536\n[Install]\nWantedBy=multi-user.target\nEOF")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("手工签发证书")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl create clusterrolebinding kubelet-clinet "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--clusterrole"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("system:node  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--user"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("system:anonymous\n")])])])]),t._v(" "),e("li",[e("p",[t._v("启动并设置开机启动")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("systemctl daemon-reload\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" kubelet\nsystemctl start kubelet\nsystemctl status kubelet\n")])])])]),t._v(" "),e("li",[e("p",[t._v("批准 kubelet 证书申请并加入集群")])])]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[t._v('```bash\nkubectl get  csr\n```\n\n上述命令会返回信息：\n\n```bash\nNAME                                                   AGE   SIGNERNAME                                    REQUESTOR          CONDITION\nnode-csr-V_M5fWeyzoOWZQZoxFOAALPd8dzXGuchY_RzmWzvJyo   18m   kubernetes.io/kube-apiserver-client-kubelet   system:anonymous   Pending\n```\n\n<a data-fancybox title="image-20201111222237041" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-11-11/1d33d11ad43140e389ff81dbddd7d6fc.png">![image-20201111222237041](http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-11-11/1d33d11ad43140e389ff81dbddd7d6fc.png)</a>\n')])])]),e("ol",{attrs:{start:"12"}},[e("li",[e("p",[t._v("批准申请")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl certificate approve node-csr-V_M5fWeyzoOWZQZoxFOAALPd8dzXGuchY_RzmWzvJyo\n")])])]),e("p",[e("a",{attrs:{"data-fancybox":"",title:"image-20201111222350151",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-11-11/c225c2d2275746e588d55a73a76f8fed.png"}},[e("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-11-11/c225c2d2275746e588d55a73a76f8fed.png",alt:"image-20201111222350151"}})])])]),t._v(" "),e("li",[e("p",[t._v("查看节点")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl get node\n")])])])])]),t._v(" "),e("h3",{attrs:{id:"_7-2-部署-kube-proxy"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-2-部署-kube-proxy"}},[t._v("#")]),t._v(" 7.2  部署 kube-proxy")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("创建配置文件")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /opt/module/kubernetes/config/kube-proxy.conf "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('EOF\nKUBE_PROXY_OPTS="--logtostderr=false '),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--v=2 "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v("\n--log-dir=/opt/module/kubernetes/logs "),e("span",{pre:!0,attrs:{class:"token entity",title:"\\\\"}},[t._v("\\\\")]),t._v('\n--config=/opt/module/kubernetes/config/kube-proxy-config.yml"\nEOF')]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("配置参数文件")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /opt/module/kubernetes/config/kube-proxy-config.yml "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF\nkind: KubeProxyConfiguration\napiVersion: kubeproxy.config.k8s.io/v1alpha1\nbindAddress: 0.0.0.0\nmetricsBindAddress: 0.0.0.0:10249\nclientConnection:\n  kubeconfig: /opt/module/kubernetes/config/kube-proxy.kubeconfig\nhostnameOverride: node1\nclusterCIDR: 10.0.0.0/24\nEOF")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("生成 kube-proxy.kubeconfig 文件")]),t._v(" "),e("p",[t._v("创建证书请求文件")]),t._v(" "),e("div",{staticClass:"language-json extra-class"},[e("pre",{pre:!0,attrs:{class:"language-json"}},[e("code",[t._v("cat > /opt/module/kubernetes/config/kube-proxy-csr.json << EOF\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"CN"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"system:kube-proxy"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"hosts"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"key"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"algo"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"rsa"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"size"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2048")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"names"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"C"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"CN"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"L"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"BeiJing"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"ST"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"BeiJing"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"O"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"k8s"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token property"}},[t._v('"OU"')]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"System"')]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\nEOF\n")])])]),e("p",[t._v("生成证书")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("cfssl gencert -ca"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/opt/module/kubernetes/pem/ca.pem "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-ca-key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/opt/module/kubernetes/pem/ca-key.pem "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-config"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/opt/module/kubernetes/config/ca-config.json "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-profile"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("kubernetes /opt/module/kubernetes/config/kube-proxy-csr.json "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\ncfssljson -bare kube-proxy\n")])])]),e("p",[t._v("注：这里在/opt/module/kubernetes/config目录下执行命令")]),t._v(" "),e("p",[t._v("生成 kube-proxy.kubeconfig 文件")]),t._v(" "),e("p",[t._v("运行命令：在/opt/module/kubernetes/config目录下运行")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl config set-cluster kubernetes "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--certificate-authority"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/opt/module/kubernetes/pem/ca.pem "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--embed-certs"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--server"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("https://192.168.76.8:6443 "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--kubeconfig"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("kube-proxy.kubeconfig\n")])])]),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl config set-credentials kube-proxy "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--client-certificate"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/opt/module/kubernetes/pem/kube-proxy.pem "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--client-key"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/opt/module/kubernetes/pem/kube-proxy-key.pem "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--embed-certs"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("true "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--kubeconfig"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("kube-proxy.kubeconfig\n")])])]),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl config set-context default "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--cluster"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("kubernetes "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--user"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("kube-proxy "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--kubeconfig"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("kube-proxy.kubeconfig\n")])])]),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl config use-context default --kubeconfig"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("kube-proxy.kubeconfig\n")])])])]),t._v(" "),e("li",[e("p",[t._v("将kube-proxy注册为系统服务")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /usr/lib/systemd/system/kube-proxy.service "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("EOF\n[Unit]\nDescription=Kubernetes Proxy\nAfter=network.target\n[Service]\nEnvironmentFile=/opt/module/kubernetes/config/kube-proxy.conf\nExecStart=/opt/module/kubernetes/bin/kube-proxy \\"),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$KUBE_PROXY_OPTS")]),t._v("\nRestart=on-failure\nLimitNOFILE=65536\n[Install]\nWantedBy=multi-user.target\nEOF")]),t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("启动并设置开机启动")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("systemctl daemon-reload\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" kube-proxy\nsystemctl start kube-proxy\nsystemctl status kube-proxy\n")])])])])]),t._v(" "),e("h3",{attrs:{id:"_7-3-部署cni网络"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-3-部署cni网络"}},[t._v("#")]),t._v(" 7.3 部署CNI网络")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("下载")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://github.com/containernetworking/plugins/releases/download/v0.8.6/cni-plugins-linux-amd64-v0.8.6.tgz\n\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://g.ioiox.com/https://github.com/containernetworking/plugins/releases/download/v0.8.6/cni-plugins-linux-amd64-v0.8.6.tgz\n")])])])]),t._v(" "),e("li",[e("p",[t._v("解压安装")])]),t._v(" "),e("li",[e("p",[t._v("下载配置文件")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml\n\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://g.ioiox.com/https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml\n")])])])]),t._v(" "),e("li",[e("p",[t._v("修改配置文件")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" -i -r "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"s#quay.io/coreos/flannel:.*-amd64#lizhenliang/flannel:v0.12.0-amd64#g"')]),t._v(" kube-flannel.yml\n")])])]),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl apply -f kube-flannel.yml\nkubectl get pods -n kube-system\nkubectl get node\n")])])])])]),t._v(" "),e("h3",{attrs:{id:"_7-4-授权apiserver访问kubectl"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_7-4-授权apiserver访问kubectl"}},[t._v("#")]),t._v(" 7.4 授权apiserver访问kubectl")]),t._v(" "),e("div",{staticClass:"language-yaml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[t._v("cat "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")]),t._v(" apiserver"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("to"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("kubelet"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rbac.yaml << EOF\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rbac.authorization.k8s.io/v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ClusterRole\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("annotations")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rbac.authorization.kubernetes.io/autoupdate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"true"')]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("labels")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kubernetes.io/bootstrapping")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rbac"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("defaults\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" system"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("kube"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("apiserver"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("to"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("kubelet\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rules")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiGroups")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("resources")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" nodes/proxy\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" nodes/stats\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" nodes/log\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" nodes/spec\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" nodes/metrics\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" pods/log\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("verbs")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"*"')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiVersion")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rbac.authorization.k8s.io/v1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ClusterRoleBinding\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("metadata")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" system"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("kube"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("apiserver\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("namespace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("roleRef")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiGroup")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rbac.authorization.k8s.io\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ClusterRole\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" system"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("kube"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("apiserver"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("to"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("kubelet\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("subjects")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("apiGroup")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rbac.authorization.k8s.io\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("kind")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" User\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" kubernetes\nEOF\n")])])]),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl apply -f apiserver-to-kubelet-rbac.yaml\n")])])]),e("h2",{attrs:{id:"八、部署集群网络"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#八、部署集群网络"}},[t._v("#")]),t._v(" 八、部署集群网络")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("在主节点上，拷贝kubernates相关内容拷贝到从节点服务器")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scp")]),t._v(" -r /opt/module/kubernetes root@192.168.76.9:/opr/module\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scp")]),t._v(" -r /opt/module/kubernetes root@192.168.76.10:/opr/module\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scp")]),t._v(" -r /usr/lib/systemd/system/"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("kubelet,kube-proxy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(".service root@192.168.76.9:/usr/lib/systemd/system/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("scp")]),t._v(" -r /usr/lib/systemd/system/"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("kubelet,kube-proxy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(".service root@192.168.76.10:/usr/lib/systemd/system/\n")])])])]),t._v(" "),e("li",[e("p",[t._v("在从节点上，删除相关文件")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -rf /opt/module/kubernates/config/kubelet.kubeconfig\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -rf /opt/module/kubernates/pem/kubelet*\n")])])])]),t._v(" "),e("li",[e("p",[t._v("在从节点上，修改配置文件")]),t._v(" "),e("p",[t._v("修改主机名")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" /opt/module/kubernates/config/kubelet.conf\n")])])]),e("p",[e("a",{attrs:{"data-fancybox":"",title:"image-20201111230242157",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-11-11/92fe344c7c9a496287fa5e61e4a9b052.png"}},[e("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-11-11/92fe344c7c9a496287fa5e61e4a9b052.png",alt:"image-20201111230242157"}})])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" /opt/module/kubernates/config/kube-proxy-config.yml\n")])])]),e("p",[e("a",{attrs:{"data-fancybox":"",title:"image-20201111230346893",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-11-11/c8e7ee3d402e45d78615560e4e6ab2af.png"}},[e("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-11-11/c8e7ee3d402e45d78615560e4e6ab2af.png",alt:"image-20201111230346893"}})])])]),t._v(" "),e("li",[e("p",[t._v("在从节点上设置kubelet、kube-proxy开机自启并启动")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("systemctl deamon-reload\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" kubelet\nsystemctl "),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("enable")]),t._v(" kube-proxy\nsystemctl start kubelet\nsystemctl start kube-proxy\n")])])])]),t._v(" "),e("li",[e("p",[t._v("将从节点加入集群")]),t._v(" "),e("p",[t._v("在主节点上执行")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl get csr\n")])])]),e("p",[e("a",{attrs:{"data-fancybox":"",title:"image-20201111230730593",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-11-11/8fc92cd71c4a48698793d7a0a84bbd60.png"}},[e("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-11-11/8fc92cd71c4a48698793d7a0a84bbd60.png",alt:"image-20201111230730593"}})])]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl certificate approve node-csr-Pt5L9vZUUo8mBR1A6DWfRTDYwf6rffNjnbsSTbh1z-k\nkubectl certificate approve node-csr-uFob5X949by2gFKPDFfe3EisFPWTgwXbFUpikIE1Osk\n")])])])])]),t._v(" "),e("h2",{attrs:{id:"九、卸载"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#九、卸载"}},[t._v("#")]),t._v(" 九、卸载")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("systemctl stop etcd\nsystemctl stop docker\nsystemctl stop kube-apiserver\nsystemctl stop kube-controller-manager\nsystemctl stop kube-scheduler\nsystemctl stop kubelet\nsystemctl stop kube-proxy\n")])])]),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("systemctl disable etcd\nsystemctl disable docker\nsystemctl disable kube-apiserver\nsystemctl disable kube-controller-manager\nsystemctl disable kube-scheduler\nsystemctl disable kubelet\nsystemctl disable kube-proxy\n")])])]),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -rf /lib/systemd/system/kube-apiserver.service\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -rf /lib/systemd/system/kube-controller-manager.service\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -rf /lib/systemd/system/kubelet.service\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -rf /lib/systemd/system/kube-proxy.service\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -rf /lib/systemd/system/kube-scheduler.service\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -rf /lib/systemd/system/docker.service\n")])])]),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -rf /opt/module/cfssl\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -rf /opt/module/cni\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -rf /opt/module/docker\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -rf /opt/module/etcd\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -rf /opt/module/flanneld\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("rm")]),t._v(" -rf /opt/module/kubernetes\n")])])]),e("h2",{attrs:{id:"十、踩坑"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#十、踩坑"}},[t._v("#")]),t._v(" 十、踩坑")]),t._v(" "),e("h3",{attrs:{id:"_9-1-启动kubelet报错："}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_9-1-启动kubelet报错："}},[t._v("#")]),t._v(" 9.1 启动kubelet报错：")]),t._v(" "),e("p",[e("a",{attrs:{"data-fancybox":"",title:"image-20201111215904611",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-11-11/811860db10a64eb885f45455bf2a5f91.png"}},[e("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-11-11/811860db10a64eb885f45455bf2a5f91.png",alt:"image-20201111215904611"}})])]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v('Nov 11 21:44:53 node1 kubelet: F1111 21:44:53.577038   79534 server.go:274] failed to run Kubelet: cannot create certificate signing request: certificatesigningrequests.certificates.k8s.io is forbidden: User "system:anonymous" cannot create resource "certificatesigningrequests" in API group "certificates.k8s.io" at the cluster scope\n')])])]),e("p",[t._v("原因：缺少对system:anonymous用户的授权")]),t._v(" "),e("p",[t._v("解决方法：对该用户手工签发证书")]),t._v(" "),e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[t._v("kubectl create clusterrolebinding kubelet-clinet "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--clusterrole"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("system:node  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v(" \n--user"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("system:anonymous\n")])])]),e("h3",{attrs:{id:"_9-2-cni配置文件初始化问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#_9-2-cni配置文件初始化问题"}},[t._v("#")]),t._v(" 9.2 CNI配置文件初始化问题")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[t._v("Container runtime network not ready: NetworkReady=false reason:NetworkPluginNotReady message:docker: network plugin is not ready: cni config uninitialized\n")])])])])}),[],!1,null,null,null);s.default=n.exports}}]);