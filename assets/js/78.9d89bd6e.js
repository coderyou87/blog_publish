(window.webpackJsonp=window.webpackJsonp||[]).push([[78],{421:function(a,t,s){"use strict";s.r(t);var e=s(42),n=Object(e.a)({},(function(){var a=this,t=a.$createElement,s=a._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":a.$parent.slotKey}},[s("h1",{attrs:{id:"volatile与java内存模型"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#volatile与java内存模型"}},[a._v("#")]),a._v(" Volatile与Java内存模型")]),a._v(" "),s("p",[a._v("被Volatile修饰的变量有两大特点：可见性与有序性（禁止重排）")]),a._v(" "),s("p",[a._v("Volatile的内存语义：")]),a._v(" "),s("ol",[s("li",[a._v("当写一个volatile变量时，JMM会把该线程对应的本地内存中的共享变量值"),s("strong",[a._v("立即刷新回主内存中")]),a._v("。")]),a._v(" "),s("li",[a._v("当读一个volatile变量时，JMM会把该线程对应的本地内存设置为无效，"),s("strong",[a._v("直接从主内存中读取共享变量")])]),a._v(" "),s("li",[a._v("所以volatile的写内存语义是直接刷新到主内存中，读的内存语义是直接从主内存中读取。")])]),a._v(" "),s("h2",{attrs:{id:"一、内存屏障"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#一、内存屏障"}},[a._v("#")]),a._v(" 一、内存屏障")]),a._v(" "),s("p",[a._v("内存屏障（也称内存栅栏，内存栅障，屏障指令等，是一类同步屏障指令，是CPU或编译器在对内存随机访问的操作中的一个同步点，使得此点之前的所有读写操作都执行后才可以开始执行此点之后的操作），避免代码重排序。内存屏障其实就是一种JVM指令，"),s("strong",[a._v("Java内存模型的重排规则会要求Java编译器在生成JVM指令时插入特定的内存屏障指令")]),a._v("，通过这些内存屏障指令，volatile实现了Java内存模型中的可见性和有序性，但volatile无法保证原子性。")]),a._v(" "),s("p",[s("strong",[a._v("内存屏障之前的所有写操作都要回写到主内存，")]),a._v(" "),s("strong",[a._v("内存屏障之后的所有读操作都能获得内存屏障之前的所有写操作的最新结果(实现了可见性)。")])]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210413220212397",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/a017bc4a51c34a3381fd06b4c9b349ee.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/a017bc4a51c34a3381fd06b4c9b349ee.png",alt:"image-20210413220212397"}})])]),a._v(" "),s("p",[a._v("因此重排序时，不允许把内存屏障之后的指令重排序到内存屏障之前。\n一句话："),s("strong",[a._v("对一个 volatile 域的写, happens-before 于任意后续对这个 volatile 域的读，也叫写后读。")])]),a._v(" "),s("p",[a._v("Volatile为什么可以保证可见性和有序性？")]),a._v(" "),s("p",[a._v("答："),s("strong",[a._v("因为有内存屏障（Memory Barriers / Fences）")])]),a._v(" "),s("p",[a._v("JVM中提供了四类内存屏障指令：")]),a._v(" "),s("p",[s("strong",[a._v("JMM中规定的happens-before先行发生原则，类似接口规范，具体的实现靠的是内存屏障")])]),a._v(" "),s("p",[a._v("源码：")]),a._v(" "),s("p",[a._v("Unsafe.class")]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210413220736629",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/1839e644df1f4c7789754212208cd4b3.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/1839e644df1f4c7789754212208cd4b3.png",alt:"image-20210413220736629"}})])]),a._v(" "),s("p",[a._v("Unsafe.java")]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210413220759237",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/052d383c5886410583f40c683dca5d76.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/052d383c5886410583f40c683dca5d76.png",alt:"image-20210413220759237"}})])]),a._v(" "),s("p",[a._v("Unsafe.cpp")]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210413220815909",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/a6dfb06431d047fa8ced5ab640b9ffce.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/a6dfb06431d047fa8ced5ab640b9ffce.png",alt:"image-20210413220815909"}})])]),a._v(" "),s("p",[a._v("OrderAccess.hpp")]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210413220838932",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/3c9459b36d0b42e28b2d560907019dd8.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/3c9459b36d0b42e28b2d560907019dd8.png",alt:"image-20210413220838932"}})])]),a._v(" "),s("p",[a._v("orderAccess_linux_x86.inline.hpp")]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210413220857185",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/06ccdf6bd1304ecf81e0ee7083f73bce.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/06ccdf6bd1304ecf81e0ee7083f73bce.png",alt:"image-20210413220857185"}})])]),a._v(" "),s("p",[s("strong",[a._v("四大内存屏障具体含义：")])]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210413220944405",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/87c6a9d1eb6b45e8843e9a55beb7356c.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/87c6a9d1eb6b45e8843e9a55beb7356c.png",alt:"image-20210413220944405"}})])]),a._v(" "),s("p",[s("strong",[a._v("happens-before之Volatile变量规则")])]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210413224043880",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/ca49b80b92d74a0b803ce16ad4357ec6.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/ca49b80b92d74a0b803ce16ad4357ec6.png",alt:"image-20210413224043880"}})])]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210413224056462",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/66eedfb2405a4bb48ccf83db6754f7d3.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/66eedfb2405a4bb48ccf83db6754f7d3.png",alt:"image-20210413224056462"}})])]),a._v(" "),s("p",[a._v("JMM中关于内存屏障的4种插入策略")]),a._v(" "),s("p",[s("strong",[a._v("写：")])]),a._v(" "),s("ol",[s("li",[s("strong",[a._v("在每个 volatile 写操作的前⾯插⼊⼀个 StoreStore 屏障")])]),a._v(" "),s("li",[s("strong",[a._v("在每个 volatile 写操作的后⾯插⼊⼀个 StoreLoad 屏障")])])]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210413224637080",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/3201ffad3d844a648025867d6916dd2f.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/3201ffad3d844a648025867d6916dd2f.png",alt:"image-20210413224637080"}})])]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210413224646669",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/8ca36b3a89f34e0d802f73c32cf1edc8.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/8ca36b3a89f34e0d802f73c32cf1edc8.png",alt:"image-20210413224646669"}})])]),a._v(" "),s("p",[s("strong",[a._v("读：")])]),a._v(" "),s("ol",[s("li",[s("strong",[a._v("在每个 volatile 读操作的后⾯插⼊⼀个 LoadLoad 屏障")])]),a._v(" "),s("li",[s("strong",[a._v("在每个 volatile 读操作的后⾯插⼊⼀个 LoadStore 屏障")])])]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210413224558041",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/a4baf99c354c479481d6cffdab3a9646.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/a4baf99c354c479481d6cffdab3a9646.png",alt:"image-20210413224558041"}})])]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210413224607247",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/2de790470fa34b4289df95a273051585.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/2de790470fa34b4289df95a273051585.png",alt:"image-20210413224607247"}})])]),a._v(" "),s("h2",{attrs:{id:"二、volatile的特性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#二、volatile的特性"}},[a._v("#")]),a._v(" 二、Volatile的特性")]),a._v(" "),s("h3",{attrs:{id:"_2-1-保证可见性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-保证可见性"}},[a._v("#")]),a._v(" 2.1 保证可见性")]),a._v(" "),s("p",[s("strong",[a._v("保证不同线程对这个变量进行操作时的可见性，即变量一旦改变所有线程立即可见")])]),a._v(" "),s("p",[a._v("示例：")]),a._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("VolatileDemo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 没有volatile修饰，没有可见性")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("//static boolean flag = true;")]),a._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("// 加了volatile修饰，保证可见性")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("volatile")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("static")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("boolean")]),a._v(" flag "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("static")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("throws")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("InterruptedException")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Thread")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("->")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("while")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("flag"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Integer")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("308")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Thread")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("currentThread")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("getName")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('" 程序结束"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(",")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"Thread1"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("start")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("TimeUnit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("MILLISECONDS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sleep")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("500")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n        flag "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),s("ul",[s("li",[a._v("不加Volatile，没有可见性，程序无法停止")]),a._v(" "),s("li",[a._v("加了Volatile，保证了可见性，程序可以停止")])]),a._v(" "),s("p",[s("strong",[a._v("在没有使用Volatile的情况下，为什么Thread1线程看不到flag的改变，原理解释：")])]),a._v(" "),s("p",[a._v("可能原因：")]),a._v(" "),s("ol",[s("li",[a._v("主线程修改了"),s("code",[a._v("flag")]),a._v("的值后，没有将最新值刷新到主内存，所以"),s("code",[a._v("Thread1")]),a._v("线程看不到")]),a._v(" "),s("li",[a._v("主线程已经将"),s("code",[a._v("flag")]),a._v("的最新值刷新到主内存中，但是"),s("code",[a._v("Thread1")]),a._v("线程一直读取的自己工作内存中的值，所以看不到"),s("code",[a._v("flag")]),a._v("修改后的值。")])]),a._v(" "),s("p",[a._v("需求：")]),a._v(" "),s("ol",[s("li",[a._v("多线程中，某个线程修改了共享变量，需要立即将修改后的值刷新到主内存中")]),a._v(" "),s("li",[a._v("每个线程，如果需要使用共享变量，每次都要从共享内存中读取最新值，并拷贝到自己的工作内存")])]),a._v(" "),s("p",[a._v("解决办法：")]),a._v(" "),s("ol",[s("li",[a._v("使用Volatile修饰共享变量，就能满足上面的需求，被Volatile修饰的共享变量，具有以下特点")]),a._v(" "),s("li",[a._v("每个线程读取共享变量时，都会从主内存中读取最新的值，并将其拷贝到自己的工作内存中")]),a._v(" "),s("li",[a._v("每个线程修改了自己工作内存中的共享变量副本，都会立即将副本刷新到主内存")])]),a._v(" "),s("p",[s("strong",[a._v("Volatile变量的读写过程")])]),a._v(" "),s("p",[s("strong",[a._v("Java内存模型中定义的8种工作内存与主内存之间的原子操作")])]),a._v(" "),s("p",[s("strong",[a._v("read(读取)→load(加载)→use(使用)→assign(赋值)→store(存储)→write(写入)→lock(锁定)→unlock(解锁)")])]),a._v(" "),s("p",[a._v("此处的lock与unlock并不是juc里面的，这是操作系统底层的")]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210413230515150",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/b48e7b2d3fed43958a8eaab506524c45.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/b48e7b2d3fed43958a8eaab506524c45.png",alt:"image-20210413230515150"}})])]),a._v(" "),s("ol",[s("li",[a._v("read: "),s("strong",[a._v("作用于主内存")]),a._v("，将变量的值从主内存传输到工作内存，主内存到工作内存")]),a._v(" "),s("li",[a._v("load: 作用于工作内存，将read从主内存传输的变量值放入工作内存变量副本中，即数据加载")]),a._v(" "),s("li",[a._v("use: 作用于工作内存，将工作内存变量副本的值传递给执行引擎，每当JVM遇到需要该变量的字节码指令时会执行该操作")]),a._v(" "),s("li",[a._v("assign: 作用于工作内存，将从执行引擎接收到的值赋值给工作内存变量，每当JVM遇到一个给变量赋值字节码指令时会执行该操作")]),a._v(" "),s("li",[a._v("store: 作用于工作内存，将赋值完毕的工作变量的值写回给主内存")]),a._v(" "),s("li",[a._v("write: "),s("strong",[a._v("作用于主内存")]),a._v("，将store传输过来的变量值赋值给主内存中的变量\n"),s("strong",[a._v("由于上述只能保证单条指令的原子性，针对多条指令的组合性原子保证，没有大面积加锁，所以，JVM提供了另外两个原子指令：")])]),a._v(" "),s("li",[a._v("lock: "),s("strong",[a._v("作用于主内存")]),a._v("，将一个变量标记为一个线程独占的状态，只是写时候加锁，就只是锁了写变量的过程。")]),a._v(" "),s("li",[a._v("unlock: "),s("strong",[a._v("作用于主内存")]),a._v("，把一个处于锁定状态的变量释放，然后才能被其他线程占用")])]),a._v(" "),s("h3",{attrs:{id:"_2-2-没有原子性"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-没有原子性"}},[a._v("#")]),a._v(" 2.2 没有原子性")]),a._v(" "),s("p",[s("strong",[a._v("Volatile变量的复合操作（i++）不具有原子性")])]),a._v(" "),s("p",[a._v("示例：")]),a._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("import")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token namespace"}},[a._v("java"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("util"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("concurrent")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("TimeUnit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("VolatileNoAtomicDemo")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("static")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("main")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("String")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("]")]),a._v(" args"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("throws")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("InterruptedException")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("MyNumber")]),a._v(" myNumber "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("MyNumber")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("10")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" i"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("++")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("new")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("Thread")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("->")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("for")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" j "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" j "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("<")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("1000")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" j"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("++")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n                    myNumber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("addPlusPlus")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n                "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("start")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("TimeUnit")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("SECONDS"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("sleep")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("5")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("myNumber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("number"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("MyNumber")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("volatile")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" number "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("addPlusPlus")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        number"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("++")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),s("p",[a._v("字节码：")]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210414000926928",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/71b3f8c2f565479a87c2523f37fdba6d.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/71b3f8c2f565479a87c2523f37fdba6d.png",alt:"image-20210414000926928"}})])]),a._v(" "),s("p",[s("strong",[a._v("原子性指的是一个操作是不可中断的")]),a._v("，即使是在多线程环境下，一个操作一旦开始就不会被其他线程影响。")]),a._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("add")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        i"),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("++")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("//不具备原子性，该操作是先读取值，然后写回一个新值，相当于原来的值加上1，分3步完成")]),a._v("\n "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),s("p",[s("strong",[a._v("如果第二个线程在第一个线程读取旧值和写回新值期间读取 "),s("code",[a._v("i")]),a._v(" 的域值")]),a._v("，那么第二个线程就会与第一个线程一起看到同一个值，并执行相同值的加1操作，这也就造成了线程安全失败，因此对于 "),s("code",[a._v("add")]),a._v(" 方法必须使用"),s("code",[a._v("synchronized")]),a._v(" 修饰，以便保证线程安全.")]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210414001108459",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/8bf9ef93d497469084eae72a82da4578.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/8bf9ef93d497469084eae72a82da4578.png",alt:"image-20210414001108459"}})])]),a._v(" "),s("p",[a._v('多线程环境下，"数据计算"和"数据赋值"操作可能多次出现，即操作非原子。若数据在加载之后，若主内存count变量发生修改之后，由于线程工作内存中的值在此前已经加载，从而不会对变更操作做出相应变化，即私有内存和公共内存中变量不同步，进而导致数据不一致\n对于volatile变量，JVM只是保证从主内存加载到线程工作内存的值是最新的，也就是数据加载时是最新的。\n'),s("strong",[a._v("由此可见volatile解决的是变量读时的可见性问题，但无法保证原子性，对于多线程修改共享变量的场景必须使用加锁同步")])]),a._v(" "),s("p",[a._v("读取复制一个普通变量的情况：当线程1对主内存对象发起read操作到write操作第一套流程的时间里，线程2随时都有可能对这个主内存对象发起第二套操作")]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210414001252767",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/35d58974f7654ecb8b26d7edd628fa44.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/35d58974f7654ecb8b26d7edd628fa44.png",alt:"image-20210414001252767"}})])]),a._v(" "),s("p",[a._v("既然使用Volatile修饰的变量，一旦某个线程修改后，其他线程在使用的时候都会读取最新值，为什么不保证原子性？")]),a._v(" "),s("p",[a._v("因为Volatile对其中部分指令做了处理：")]),a._v(" "),s("p",[a._v("要use(使用)一个变量的时候必需load(载入），要载入的时候必需从主内存read(读取）这样就解决了读的可见性（每次都读取最新的）。")]),a._v(" "),s("p",[a._v("写操作是把assign和store做了关联(在assign(赋值)后必需store(存储))。store(存储)后write(写入)。\n也就是做到了给一个变量赋值的时候一串关联指令直接把变量值写到主内存。")]),a._v(" "),s("p",[a._v("就这样通过使用的时候直接从主内存取，在赋值到直接写回主内存做到了内存可见性。")]),a._v(" "),s("p",[a._v("但是在使用（use）和赋值（assign）中间，存在一个间隙，导致了Volatile不能保证原子性")]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210414001742516",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/93fe067173f24ac58f24920d4abe473f.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/93fe067173f24ac58f24920d4abe473f.png",alt:"image-20210414001742516"}})])]),a._v(" "),s("p",[a._v("读取一个Volatile变量的情况")]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210414001815364",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/399d07cabf0f4bbd86c1baffd2dcff30.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/399d07cabf0f4bbd86c1baffd2dcff30.png",alt:"image-20210414001815364"}})])]),a._v(" "),s("p",[s("code",[a._v("read-load-use")]),a._v(" 和 "),s("code",[a._v("assign-store-write")]),a._v(" 成为了两个不可分割的原子操作，"),s("strong",[a._v("但是在use和assign之间依然有极小的一段真空期")]),a._v("，有可能变量会被其他线程读取，导致写丢失一次")]),a._v(" "),s("p",[a._v("但是无论在哪一个时间点主内存的变量和任一工作内存的变量的值都是相等的。这个特性就导致了volatile变量不适合参与到依赖当前值的运算，如"),s("code",[a._v("i = i + 1; i++;")]),a._v("之类的那么依靠可见性的特点。volatile可以用在哪些地方呢？ "),s("strong",[a._v("通常volatile用做保存某个状态的boolean值or int值")]),a._v("。\n《深入理解Java虚拟机》提到：")]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210414002009198",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/a3e06413bb7b4c0e873dfa580465fe06.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/a3e06413bb7b4c0e873dfa580465fe06.png",alt:"image-20210414002009198"}})])]),a._v(" "),s("p",[a._v("面试：为什么Volatile不保证原子性？")]),a._v(" "),s("p",[a._v("答："),s("strong",[a._v("JVM的字节码，i++分成三步，间隙期不同步非原子操作(i++)")])]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210414002200327",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/842815b6b64643de868bbbec216f4c0f.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/842815b6b64643de868bbbec216f4c0f.png",alt:"image-20210414002200327"}})])]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210414002219509",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/a64edd4cfab24d0489ba8e1bcf0986cf.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/a64edd4cfab24d0489ba8e1bcf0986cf.png",alt:"image-20210414002219509"}})])]),a._v(" "),s("h3",{attrs:{id:"_2-3-指令禁重排"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-指令禁重排"}},[a._v("#")]),a._v(" 2.3 指令禁重排")]),a._v(" "),s("p",[a._v("重排序是指编译器和处理器为了优化程序性能而对指令序列进行重新排序的一种手段，有时候会改变程序语句的先后顺序\n"),s("strong",[a._v("不存在数据依赖关系，可以重排序；")]),a._v(" "),s("strong",[a._v("存在数据依赖关系，禁止重排序")]),a._v("\n**但重排后的指令绝对不能改变原有的串行语义！**这点在并发设计中必须要重点考虑！")]),a._v(" "),s("p",[a._v("重排序的分类和执行流程")]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210414002542157",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/14a70ae4b7b94d1e89d65d8dca47e552.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/14a70ae4b7b94d1e89d65d8dca47e552.png",alt:"image-20210414002542157"}})])]),a._v(" "),s("p",[s("strong",[a._v("编译器优化的重排序")]),a._v("： 编译器在不改变单线程串行语义的前提下，可以重新调整指令的执行顺序\n"),s("strong",[a._v("指令级并行的重排序")]),a._v("： 处理器使用指令级并行技术来将多条指令重叠执行，若不存在数据依赖性，处理器可以改变语句对应机器指令的执行顺序\n"),s("strong",[a._v("内存系统的重排序")]),a._v("： 由于处理器使用缓存和读/写缓冲区，这使得加载和存储操作看上去可能是乱序执行")]),a._v(" "),s("p",[s("strong",[a._v("数据依赖性")]),a._v("：若两个操作访问同一变量，且这两个操作中有一个为写操作，此时两操作间就存在数据依赖性。")]),a._v(" "),s("p",[a._v("案例 ：")]),a._v(" "),s("p",[s("strong",[a._v("不存在数据依赖关系，可以重排序")])]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210414002743094",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/abe6c8fd9ba44a608b693c1106304b60.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/abe6c8fd9ba44a608b693c1106304b60.png",alt:"image-20210414002743094"}})])]),a._v(" "),s("p",[s("strong",[a._v("存在数据依赖关系，禁止重排序")]),a._v("===> "),s("strong",[a._v("重排序发生，会导致程序运行结果不同")]),a._v("。")]),a._v(" "),s("p",[a._v("编译器和处理器在重排序时，会遵守数据依赖性，不会改变存在依赖关系的两个操作的执行,但不同处理器和不同线程之间的数据不会被编译器和处理器考虑，其只会作用于单处理器和单线程环境，下面三种情况，只要重排序两个操作的执行顺序，程序的执行结果就会被改变。")]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210414002813391",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/3b8e04ff3b5743b5820f346c12c7de8f.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/3b8e04ff3b5743b5820f346c12c7de8f.png",alt:"image-20210414002813391"}})])]),a._v(" "),s("p",[s("strong",[a._v("Volatile的底层是通过内存屏障来实现禁止指令重排的")])]),a._v(" "),s("p",[a._v("Volatile有关的禁止指令重排的行为")]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210414003000050",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/b93f19c309f740c48be12d404802a5e3.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/b93f19c309f740c48be12d404802a5e3.png",alt:"image-20210414003000050"}})])]),a._v(" "),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210414003008411",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/e6f84aca5a5f4e348e5b898deb0d29d0.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/e6f84aca5a5f4e348e5b898deb0d29d0.png",alt:"image-20210414003008411"}})])]),a._v(" "),s("p",[s("strong",[a._v("四大屏障的插入情况")])]),a._v(" "),s("ol",[s("li",[s("p",[a._v("在每一个volatile写操作前面插入一个StoreStore屏障")]),a._v(" "),s("p",[a._v("StoreStore屏障可以保证在volatile写之前，其前面的所有普通写操作都已经刷新到主内存中。")])]),a._v(" "),s("li",[s("p",[a._v("在每一个volatile写操作后面插入一个StoreLoad屏障")]),a._v(" "),s("p",[a._v("StoreLoad屏障的作用是避免volatile写与后面可能有的volatile读/写操作重排序")])]),a._v(" "),s("li",[s("p",[a._v("在每一个volatile读操作后面插入一个LoadLoad屏障")]),a._v(" "),s("p",[a._v("LoadLoad屏障用来禁止处理器把上面的volatile读与下面的普通读重排序。")])]),a._v(" "),s("li",[s("p",[a._v("在每一个volatile读操作后面插入一个LoadStore屏障")]),a._v(" "),s("p",[a._v("LoadStore屏障用来禁止处理器把上面的volatile读与下面的普通写重排序。")])])]),a._v(" "),s("p",[s("strong",[a._v("案例：")])]),a._v(" "),s("div",{staticClass:"language-java extra-class"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[a._v("//模拟一个单线程，什么顺序读？什么顺序写？")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("class")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("VolatileTest")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("int")]),a._v(" i "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("0")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("volatile")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("boolean")]),a._v(" flag "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("false")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("write")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        i "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[a._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        flag "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("=")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token boolean"}},[a._v("true")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("public")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("void")]),a._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("read")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token keyword"}},[a._v("if")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),a._v("flag"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("{")]),a._v("\n            "),s("span",{pre:!0,attrs:{class:"token class-name"}},[a._v("System")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),a._v("out"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[a._v("println")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[a._v('"---i = "')]),a._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[a._v("+")]),a._v(" i"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v(";")]),a._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[a._v("}")]),a._v("\n")])])]),s("p",[s("a",{attrs:{"data-fancybox":"",title:"image-20210414003609061",href:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/7d114d477f604f60850c36b3aba78354.png"}},[s("img",{attrs:{src:"http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/7d114d477f604f60850c36b3aba78354.png",alt:"image-20210414003609061"}})])]),a._v(" "),s("h2",{attrs:{id:"三、如何正确使用volatile"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#三、如何正确使用volatile"}},[a._v("#")]),a._v(" 三、如何正确使用Volatile")])])}),[],!1,null,null,null);t.default=n.exports}}]);