<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Volatile与Java内存模型 | coder</title>
    <meta name="generator" content="VuePress 1.5.2">
    <link rel="icon1" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-02-18/d687f535b564447e82a3178a4e9b2f8c.jpg">
    <link rel="icon2" href="https://you-blog.oss-cn-shenzhen.aliyuncs.com/typora/2021-02-18/icon.jpg">
    <script src="/css/jquery.slim.min.js"></script>
    <script src="/css/jquery.fancybox.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.min.css">
    <meta name="description" content="知行合一">
    <link rel="preload" href="/assets/css/0.styles.76271d17.css" as="style"><link rel="preload" href="/assets/js/app.ba474f6b.js" as="script"><link rel="preload" href="/assets/js/2.92f2819f.js" as="script"><link rel="preload" href="/assets/js/78.09c3bef7.js" as="script"><link rel="prefetch" href="/assets/js/10.b8e98ea8.js"><link rel="prefetch" href="/assets/js/100.c91f48ac.js"><link rel="prefetch" href="/assets/js/101.25da26dd.js"><link rel="prefetch" href="/assets/js/102.5241a842.js"><link rel="prefetch" href="/assets/js/103.30ac13f6.js"><link rel="prefetch" href="/assets/js/104.c36e99ea.js"><link rel="prefetch" href="/assets/js/105.0b04cb0d.js"><link rel="prefetch" href="/assets/js/106.8a6d905c.js"><link rel="prefetch" href="/assets/js/107.13ab2151.js"><link rel="prefetch" href="/assets/js/108.9f0fe2b0.js"><link rel="prefetch" href="/assets/js/109.80d909a3.js"><link rel="prefetch" href="/assets/js/11.dece430d.js"><link rel="prefetch" href="/assets/js/110.1229c377.js"><link rel="prefetch" href="/assets/js/111.be5d98db.js"><link rel="prefetch" href="/assets/js/112.9a42977b.js"><link rel="prefetch" href="/assets/js/113.63070a5c.js"><link rel="prefetch" href="/assets/js/114.7662291d.js"><link rel="prefetch" href="/assets/js/115.aa4e5a63.js"><link rel="prefetch" href="/assets/js/116.22632cb4.js"><link rel="prefetch" href="/assets/js/117.448e175a.js"><link rel="prefetch" href="/assets/js/118.2b5a0043.js"><link rel="prefetch" href="/assets/js/119.d1a92d45.js"><link rel="prefetch" href="/assets/js/12.c0cbcc4a.js"><link rel="prefetch" href="/assets/js/120.71489ff3.js"><link rel="prefetch" href="/assets/js/121.986f735c.js"><link rel="prefetch" href="/assets/js/122.9aaa801a.js"><link rel="prefetch" href="/assets/js/123.372fd139.js"><link rel="prefetch" href="/assets/js/124.0c502dc1.js"><link rel="prefetch" href="/assets/js/125.4ffcf33c.js"><link rel="prefetch" href="/assets/js/126.fa2b235d.js"><link rel="prefetch" href="/assets/js/127.bb92d209.js"><link rel="prefetch" href="/assets/js/128.e6f2f2f8.js"><link rel="prefetch" href="/assets/js/129.4efba7d9.js"><link rel="prefetch" href="/assets/js/13.3e1fee42.js"><link rel="prefetch" href="/assets/js/130.91758720.js"><link rel="prefetch" href="/assets/js/131.a16cff2a.js"><link rel="prefetch" href="/assets/js/132.4397af00.js"><link rel="prefetch" href="/assets/js/133.4617d3fe.js"><link rel="prefetch" href="/assets/js/134.84e29cf4.js"><link rel="prefetch" href="/assets/js/135.f2be934a.js"><link rel="prefetch" href="/assets/js/136.7455212a.js"><link rel="prefetch" href="/assets/js/137.51f8a051.js"><link rel="prefetch" href="/assets/js/138.15129d2d.js"><link rel="prefetch" href="/assets/js/139.b4031d29.js"><link rel="prefetch" href="/assets/js/14.9ff1a594.js"><link rel="prefetch" href="/assets/js/140.490ab53a.js"><link rel="prefetch" href="/assets/js/141.f828cb0d.js"><link rel="prefetch" href="/assets/js/142.a91c99db.js"><link rel="prefetch" href="/assets/js/143.c61ace89.js"><link rel="prefetch" href="/assets/js/144.6e0d6718.js"><link rel="prefetch" href="/assets/js/145.8696410b.js"><link rel="prefetch" href="/assets/js/146.78c11d9a.js"><link rel="prefetch" href="/assets/js/147.0997a658.js"><link rel="prefetch" href="/assets/js/148.95caa9a2.js"><link rel="prefetch" href="/assets/js/149.1edea028.js"><link rel="prefetch" href="/assets/js/15.1dc535fd.js"><link rel="prefetch" href="/assets/js/150.75246cad.js"><link rel="prefetch" href="/assets/js/151.b1a20d3d.js"><link rel="prefetch" href="/assets/js/152.35323c33.js"><link rel="prefetch" href="/assets/js/153.e8a07e92.js"><link rel="prefetch" href="/assets/js/154.9e340011.js"><link rel="prefetch" href="/assets/js/155.f479ad43.js"><link rel="prefetch" href="/assets/js/156.97192566.js"><link rel="prefetch" href="/assets/js/157.1c4ff3e8.js"><link rel="prefetch" href="/assets/js/158.d96ea397.js"><link rel="prefetch" href="/assets/js/159.0f55b599.js"><link rel="prefetch" href="/assets/js/16.8846169c.js"><link rel="prefetch" href="/assets/js/160.db7081e7.js"><link rel="prefetch" href="/assets/js/161.728959f2.js"><link rel="prefetch" href="/assets/js/162.3d9e425f.js"><link rel="prefetch" href="/assets/js/163.98406fd7.js"><link rel="prefetch" href="/assets/js/164.b4a7a898.js"><link rel="prefetch" href="/assets/js/165.41762074.js"><link rel="prefetch" href="/assets/js/166.cca0714a.js"><link rel="prefetch" href="/assets/js/167.20d13d31.js"><link rel="prefetch" href="/assets/js/168.65cd4b39.js"><link rel="prefetch" href="/assets/js/169.e774fc35.js"><link rel="prefetch" href="/assets/js/17.4240e60f.js"><link rel="prefetch" href="/assets/js/170.c680702a.js"><link rel="prefetch" href="/assets/js/171.aed76e50.js"><link rel="prefetch" href="/assets/js/172.f0126100.js"><link rel="prefetch" href="/assets/js/173.e13c21ae.js"><link rel="prefetch" href="/assets/js/174.95e6e362.js"><link rel="prefetch" href="/assets/js/175.9bc06660.js"><link rel="prefetch" href="/assets/js/176.2f30efee.js"><link rel="prefetch" href="/assets/js/177.9dda8b29.js"><link rel="prefetch" href="/assets/js/178.d60323ee.js"><link rel="prefetch" href="/assets/js/179.d3c55d73.js"><link rel="prefetch" href="/assets/js/18.20035b10.js"><link rel="prefetch" href="/assets/js/180.ee4dcc5c.js"><link rel="prefetch" href="/assets/js/181.f62c56c8.js"><link rel="prefetch" href="/assets/js/182.843f5e64.js"><link rel="prefetch" href="/assets/js/183.f763aa33.js"><link rel="prefetch" href="/assets/js/184.bf901285.js"><link rel="prefetch" href="/assets/js/185.f37d87b1.js"><link rel="prefetch" href="/assets/js/186.44f670ac.js"><link rel="prefetch" href="/assets/js/187.d85bcdb5.js"><link rel="prefetch" href="/assets/js/188.ea46513b.js"><link rel="prefetch" href="/assets/js/189.ebb0caf5.js"><link rel="prefetch" href="/assets/js/19.ddf4ad28.js"><link rel="prefetch" href="/assets/js/190.f6c6e508.js"><link rel="prefetch" href="/assets/js/191.ce7de326.js"><link rel="prefetch" href="/assets/js/192.5c4cf6ed.js"><link rel="prefetch" href="/assets/js/193.c9f03eb5.js"><link rel="prefetch" href="/assets/js/194.678693d2.js"><link rel="prefetch" href="/assets/js/195.63bdc5a6.js"><link rel="prefetch" href="/assets/js/196.50912f7b.js"><link rel="prefetch" href="/assets/js/197.5ddce07d.js"><link rel="prefetch" href="/assets/js/198.b370879e.js"><link rel="prefetch" href="/assets/js/199.06db7d09.js"><link rel="prefetch" href="/assets/js/20.e0c8bc0f.js"><link rel="prefetch" href="/assets/js/200.bed3f667.js"><link rel="prefetch" href="/assets/js/201.1c72ab8f.js"><link rel="prefetch" href="/assets/js/202.f124d4eb.js"><link rel="prefetch" href="/assets/js/203.0607eed3.js"><link rel="prefetch" href="/assets/js/204.5238cb27.js"><link rel="prefetch" href="/assets/js/205.2d7d10ed.js"><link rel="prefetch" href="/assets/js/206.9f7d327d.js"><link rel="prefetch" href="/assets/js/207.60e15733.js"><link rel="prefetch" href="/assets/js/208.6aad5fab.js"><link rel="prefetch" href="/assets/js/209.ec102045.js"><link rel="prefetch" href="/assets/js/21.8312f373.js"><link rel="prefetch" href="/assets/js/210.bdb6b7c2.js"><link rel="prefetch" href="/assets/js/211.4047d937.js"><link rel="prefetch" href="/assets/js/212.301d6d62.js"><link rel="prefetch" href="/assets/js/213.50739b59.js"><link rel="prefetch" href="/assets/js/214.e73a7105.js"><link rel="prefetch" href="/assets/js/215.a49b9947.js"><link rel="prefetch" href="/assets/js/216.4b324c1a.js"><link rel="prefetch" href="/assets/js/217.e144a18f.js"><link rel="prefetch" href="/assets/js/218.5f8ca4c2.js"><link rel="prefetch" href="/assets/js/219.e0554e51.js"><link rel="prefetch" href="/assets/js/22.d04d92c4.js"><link rel="prefetch" href="/assets/js/220.cf69c3aa.js"><link rel="prefetch" href="/assets/js/221.90c8f39d.js"><link rel="prefetch" href="/assets/js/222.a29f7ce4.js"><link rel="prefetch" href="/assets/js/223.10946c91.js"><link rel="prefetch" href="/assets/js/224.8b8a1423.js"><link rel="prefetch" href="/assets/js/225.6ae047dc.js"><link rel="prefetch" href="/assets/js/226.78b42e02.js"><link rel="prefetch" href="/assets/js/227.fc8c6347.js"><link rel="prefetch" href="/assets/js/228.66692a4b.js"><link rel="prefetch" href="/assets/js/229.356ca19b.js"><link rel="prefetch" href="/assets/js/23.c482eb11.js"><link rel="prefetch" href="/assets/js/230.f7b66079.js"><link rel="prefetch" href="/assets/js/231.6a772507.js"><link rel="prefetch" href="/assets/js/232.8df69fe9.js"><link rel="prefetch" href="/assets/js/233.52612384.js"><link rel="prefetch" href="/assets/js/234.52d782f6.js"><link rel="prefetch" href="/assets/js/235.9de060b1.js"><link rel="prefetch" href="/assets/js/236.ead9f5f0.js"><link rel="prefetch" href="/assets/js/237.8e9aa106.js"><link rel="prefetch" href="/assets/js/238.a6fd414e.js"><link rel="prefetch" href="/assets/js/239.11a8d58d.js"><link rel="prefetch" href="/assets/js/24.d26afd36.js"><link rel="prefetch" href="/assets/js/240.cbcaacef.js"><link rel="prefetch" href="/assets/js/241.07493fa0.js"><link rel="prefetch" href="/assets/js/242.f8eba775.js"><link rel="prefetch" href="/assets/js/243.0d69ee6a.js"><link rel="prefetch" href="/assets/js/244.b7f2acb3.js"><link rel="prefetch" href="/assets/js/245.db62d2b1.js"><link rel="prefetch" href="/assets/js/246.3f95f43d.js"><link rel="prefetch" href="/assets/js/247.550dcecb.js"><link rel="prefetch" href="/assets/js/248.ad5d9107.js"><link rel="prefetch" href="/assets/js/249.ba4a1c2e.js"><link rel="prefetch" href="/assets/js/25.5e69c47c.js"><link rel="prefetch" href="/assets/js/250.454b94bc.js"><link rel="prefetch" href="/assets/js/251.f705124c.js"><link rel="prefetch" href="/assets/js/252.376cd1f6.js"><link rel="prefetch" href="/assets/js/253.f22e0165.js"><link rel="prefetch" href="/assets/js/254.43f68d20.js"><link rel="prefetch" href="/assets/js/255.7d65096e.js"><link rel="prefetch" href="/assets/js/256.155db88e.js"><link rel="prefetch" href="/assets/js/257.ca476818.js"><link rel="prefetch" href="/assets/js/258.20b486ec.js"><link rel="prefetch" href="/assets/js/259.7d54b67b.js"><link rel="prefetch" href="/assets/js/26.29975dd9.js"><link rel="prefetch" href="/assets/js/260.8039879a.js"><link rel="prefetch" href="/assets/js/261.4462ad58.js"><link rel="prefetch" href="/assets/js/262.fd8ab3ac.js"><link rel="prefetch" href="/assets/js/263.7802cb43.js"><link rel="prefetch" href="/assets/js/264.a313cf79.js"><link rel="prefetch" href="/assets/js/265.9dbe4032.js"><link rel="prefetch" href="/assets/js/266.be1fc909.js"><link rel="prefetch" href="/assets/js/267.a336fc22.js"><link rel="prefetch" href="/assets/js/268.5acf1deb.js"><link rel="prefetch" href="/assets/js/269.a48f32bd.js"><link rel="prefetch" href="/assets/js/27.6f6c01db.js"><link rel="prefetch" href="/assets/js/270.31de0f7b.js"><link rel="prefetch" href="/assets/js/271.6e2d9cb7.js"><link rel="prefetch" href="/assets/js/272.4808cad4.js"><link rel="prefetch" href="/assets/js/273.ee065bcc.js"><link rel="prefetch" href="/assets/js/274.70a94c3a.js"><link rel="prefetch" href="/assets/js/275.d36aa6b9.js"><link rel="prefetch" href="/assets/js/276.ce7f1be1.js"><link rel="prefetch" href="/assets/js/277.38eb3494.js"><link rel="prefetch" href="/assets/js/278.51ec7c0b.js"><link rel="prefetch" href="/assets/js/279.ebceda59.js"><link rel="prefetch" href="/assets/js/28.e767bebb.js"><link rel="prefetch" href="/assets/js/280.72df8098.js"><link rel="prefetch" href="/assets/js/281.a53cbf13.js"><link rel="prefetch" href="/assets/js/282.f45ea8c4.js"><link rel="prefetch" href="/assets/js/283.5b0f353a.js"><link rel="prefetch" href="/assets/js/284.14b3dc6c.js"><link rel="prefetch" href="/assets/js/285.b70e9137.js"><link rel="prefetch" href="/assets/js/286.ba2445d2.js"><link rel="prefetch" href="/assets/js/287.bd0c107d.js"><link rel="prefetch" href="/assets/js/288.d5a2c989.js"><link rel="prefetch" href="/assets/js/289.b58ae803.js"><link rel="prefetch" href="/assets/js/29.93617baf.js"><link rel="prefetch" href="/assets/js/290.ecd09d31.js"><link rel="prefetch" href="/assets/js/291.d4b22e83.js"><link rel="prefetch" href="/assets/js/292.3aff1051.js"><link rel="prefetch" href="/assets/js/293.6d9b6f2e.js"><link rel="prefetch" href="/assets/js/294.2bd94374.js"><link rel="prefetch" href="/assets/js/295.96033774.js"><link rel="prefetch" href="/assets/js/296.a58435c2.js"><link rel="prefetch" href="/assets/js/297.9517b0d9.js"><link rel="prefetch" href="/assets/js/298.2ee61fb3.js"><link rel="prefetch" href="/assets/js/299.29712670.js"><link rel="prefetch" href="/assets/js/3.9f6e2e9b.js"><link rel="prefetch" href="/assets/js/30.b3063b77.js"><link rel="prefetch" href="/assets/js/300.7eb91a89.js"><link rel="prefetch" href="/assets/js/301.11149645.js"><link rel="prefetch" href="/assets/js/302.2da76e44.js"><link rel="prefetch" href="/assets/js/303.5a97825c.js"><link rel="prefetch" href="/assets/js/304.e7e9f99c.js"><link rel="prefetch" href="/assets/js/305.729eac97.js"><link rel="prefetch" href="/assets/js/306.52446818.js"><link rel="prefetch" href="/assets/js/307.1a54b756.js"><link rel="prefetch" href="/assets/js/308.33d8443c.js"><link rel="prefetch" href="/assets/js/309.0321f687.js"><link rel="prefetch" href="/assets/js/31.ca39c57a.js"><link rel="prefetch" href="/assets/js/310.1ec03007.js"><link rel="prefetch" href="/assets/js/311.77cafd1f.js"><link rel="prefetch" href="/assets/js/312.e7f6aa92.js"><link rel="prefetch" href="/assets/js/313.4fae326e.js"><link rel="prefetch" href="/assets/js/314.22babd10.js"><link rel="prefetch" href="/assets/js/315.5ff5f546.js"><link rel="prefetch" href="/assets/js/316.d6eb0b55.js"><link rel="prefetch" href="/assets/js/317.c4a4becf.js"><link rel="prefetch" href="/assets/js/318.4917ccd1.js"><link rel="prefetch" href="/assets/js/319.7cd4c7a0.js"><link rel="prefetch" href="/assets/js/32.8a11ea47.js"><link rel="prefetch" href="/assets/js/320.08da2e96.js"><link rel="prefetch" href="/assets/js/321.c5540b43.js"><link rel="prefetch" href="/assets/js/322.8e740136.js"><link rel="prefetch" href="/assets/js/323.e41da009.js"><link rel="prefetch" href="/assets/js/324.de0b55f5.js"><link rel="prefetch" href="/assets/js/325.aeaee9f2.js"><link rel="prefetch" href="/assets/js/326.fe9cc2c4.js"><link rel="prefetch" href="/assets/js/327.a3269dd0.js"><link rel="prefetch" href="/assets/js/328.52326fe4.js"><link rel="prefetch" href="/assets/js/329.5765e07d.js"><link rel="prefetch" href="/assets/js/33.fe31247b.js"><link rel="prefetch" href="/assets/js/330.076fdf59.js"><link rel="prefetch" href="/assets/js/331.a3910492.js"><link rel="prefetch" href="/assets/js/332.4d13179f.js"><link rel="prefetch" href="/assets/js/333.db605431.js"><link rel="prefetch" href="/assets/js/334.6870fbf8.js"><link rel="prefetch" href="/assets/js/335.71882ef0.js"><link rel="prefetch" href="/assets/js/336.29b8db0b.js"><link rel="prefetch" href="/assets/js/337.19e7677d.js"><link rel="prefetch" href="/assets/js/338.f57b293c.js"><link rel="prefetch" href="/assets/js/339.aeded597.js"><link rel="prefetch" href="/assets/js/34.5519b3a6.js"><link rel="prefetch" href="/assets/js/340.1ab52514.js"><link rel="prefetch" href="/assets/js/341.7a9b437d.js"><link rel="prefetch" href="/assets/js/342.cc7e6dd0.js"><link rel="prefetch" href="/assets/js/343.16c02c2f.js"><link rel="prefetch" href="/assets/js/344.644ae544.js"><link rel="prefetch" href="/assets/js/345.cb4fcfb5.js"><link rel="prefetch" href="/assets/js/346.7834b8ea.js"><link rel="prefetch" href="/assets/js/347.08f1647e.js"><link rel="prefetch" href="/assets/js/348.bacd8eff.js"><link rel="prefetch" href="/assets/js/349.416b554e.js"><link rel="prefetch" href="/assets/js/35.aa5fe427.js"><link rel="prefetch" href="/assets/js/350.b8fa939f.js"><link rel="prefetch" href="/assets/js/351.10599bab.js"><link rel="prefetch" href="/assets/js/352.ce5a06ac.js"><link rel="prefetch" href="/assets/js/353.4e916038.js"><link rel="prefetch" href="/assets/js/354.ed54e74f.js"><link rel="prefetch" href="/assets/js/355.be7e082e.js"><link rel="prefetch" href="/assets/js/356.0c574187.js"><link rel="prefetch" href="/assets/js/357.e65cd2a0.js"><link rel="prefetch" href="/assets/js/358.4e7bd228.js"><link rel="prefetch" href="/assets/js/359.fdb52927.js"><link rel="prefetch" href="/assets/js/36.1ae1780d.js"><link rel="prefetch" href="/assets/js/360.4b6e7453.js"><link rel="prefetch" href="/assets/js/361.de9efa49.js"><link rel="prefetch" href="/assets/js/362.b55b1906.js"><link rel="prefetch" href="/assets/js/363.527901e4.js"><link rel="prefetch" href="/assets/js/364.231218d3.js"><link rel="prefetch" href="/assets/js/365.1a344294.js"><link rel="prefetch" href="/assets/js/366.c8ea1c49.js"><link rel="prefetch" href="/assets/js/367.4c82e7e9.js"><link rel="prefetch" href="/assets/js/368.b3808528.js"><link rel="prefetch" href="/assets/js/369.9700ee29.js"><link rel="prefetch" href="/assets/js/37.19d7ef75.js"><link rel="prefetch" href="/assets/js/370.65605c2e.js"><link rel="prefetch" href="/assets/js/371.1223b27c.js"><link rel="prefetch" href="/assets/js/38.258cb0c1.js"><link rel="prefetch" href="/assets/js/39.0f268d7d.js"><link rel="prefetch" href="/assets/js/4.c4f52e09.js"><link rel="prefetch" href="/assets/js/40.3c3b852e.js"><link rel="prefetch" href="/assets/js/41.4097d760.js"><link rel="prefetch" href="/assets/js/42.591984a7.js"><link rel="prefetch" href="/assets/js/43.e1cbaa8b.js"><link rel="prefetch" href="/assets/js/44.650e2b5b.js"><link rel="prefetch" href="/assets/js/45.56567d27.js"><link rel="prefetch" href="/assets/js/46.3db58dc9.js"><link rel="prefetch" href="/assets/js/47.f6fabe74.js"><link rel="prefetch" href="/assets/js/48.dec3d0d2.js"><link rel="prefetch" href="/assets/js/49.6417fcf5.js"><link rel="prefetch" href="/assets/js/5.e723c1a9.js"><link rel="prefetch" href="/assets/js/50.78409610.js"><link rel="prefetch" href="/assets/js/51.8c3db94b.js"><link rel="prefetch" href="/assets/js/52.ab9331d2.js"><link rel="prefetch" href="/assets/js/53.c87f3035.js"><link rel="prefetch" href="/assets/js/54.4ff4b7fd.js"><link rel="prefetch" href="/assets/js/55.d787c0fc.js"><link rel="prefetch" href="/assets/js/56.3744e41d.js"><link rel="prefetch" href="/assets/js/57.8f8e8c73.js"><link rel="prefetch" href="/assets/js/58.2a1927ed.js"><link rel="prefetch" href="/assets/js/59.24c87780.js"><link rel="prefetch" href="/assets/js/6.43debd78.js"><link rel="prefetch" href="/assets/js/60.72dc30a2.js"><link rel="prefetch" href="/assets/js/61.76ba61eb.js"><link rel="prefetch" href="/assets/js/62.9e0cced6.js"><link rel="prefetch" href="/assets/js/63.63ad730b.js"><link rel="prefetch" href="/assets/js/64.07a7e3a3.js"><link rel="prefetch" href="/assets/js/65.3c172f80.js"><link rel="prefetch" href="/assets/js/66.c0275e13.js"><link rel="prefetch" href="/assets/js/67.a87a6f6e.js"><link rel="prefetch" href="/assets/js/68.69d976e5.js"><link rel="prefetch" href="/assets/js/69.bfdbe5e9.js"><link rel="prefetch" href="/assets/js/7.23b88edf.js"><link rel="prefetch" href="/assets/js/70.49f5f451.js"><link rel="prefetch" href="/assets/js/71.415f2315.js"><link rel="prefetch" href="/assets/js/72.8608e946.js"><link rel="prefetch" href="/assets/js/73.dda863c5.js"><link rel="prefetch" href="/assets/js/74.0fccbeb8.js"><link rel="prefetch" href="/assets/js/75.7353b526.js"><link rel="prefetch" href="/assets/js/76.0770d54e.js"><link rel="prefetch" href="/assets/js/77.5d128881.js"><link rel="prefetch" href="/assets/js/79.99dacc09.js"><link rel="prefetch" href="/assets/js/8.9344fafb.js"><link rel="prefetch" href="/assets/js/80.d7dbccbf.js"><link rel="prefetch" href="/assets/js/81.fc4d9a9e.js"><link rel="prefetch" href="/assets/js/82.2bf1c68d.js"><link rel="prefetch" href="/assets/js/83.af673b81.js"><link rel="prefetch" href="/assets/js/84.8a6fa1bd.js"><link rel="prefetch" href="/assets/js/85.e17db901.js"><link rel="prefetch" href="/assets/js/86.23dc25fe.js"><link rel="prefetch" href="/assets/js/87.b2cc7e3f.js"><link rel="prefetch" href="/assets/js/88.05b83c84.js"><link rel="prefetch" href="/assets/js/89.3bfd9b3f.js"><link rel="prefetch" href="/assets/js/9.8c1ccb14.js"><link rel="prefetch" href="/assets/js/90.8171bd61.js"><link rel="prefetch" href="/assets/js/91.800cce9f.js"><link rel="prefetch" href="/assets/js/92.8ff96830.js"><link rel="prefetch" href="/assets/js/93.ebbadaf8.js"><link rel="prefetch" href="/assets/js/94.98d7f109.js"><link rel="prefetch" href="/assets/js/95.d3629849.js"><link rel="prefetch" href="/assets/js/96.cc729091.js"><link rel="prefetch" href="/assets/js/97.9a25e809.js"><link rel="prefetch" href="/assets/js/98.cea1a674.js"><link rel="prefetch" href="/assets/js/99.4f973974.js">
    <link rel="stylesheet" href="/assets/css/0.styles.76271d17.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">coder</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/interview/" class="nav-link">
  面试
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/01_ProgrammingBasic/link.html" class="nav-link">
  编程基础
</a></li><li class="dropdown-item"><!----> <a href="/java/02_DevelopmentTools/link.html" class="nav-link">
  开发工具
</a></li><li class="dropdown-item"><!----> <a href="/java/03_ApplicationFramework/link.html" class="nav-link">
  应用框架
</a></li><li class="dropdown-item"><!----> <a href="/java/04_OperationAndMaintenance/" class="nav-link">
  运维
</a></li><li class="dropdown-item"><!----> <a href="/java/05_SourceCode/" class="nav-link">
  源码
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/01_vue/使用webpack打包一个简单的前端程序.html" class="nav-link">
  vue
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具箱" class="dropdown-title"><span class="title">工具箱</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具箱" class="mobile-dropdown-title"><span class="title">工具箱</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/essay/04_SpringBoot中处理跨域的几种方式.html" class="nav-link">
  随笔
</a></li><li class="dropdown-item"><!----> <a href="/tools/installSoftware/01_jdk_linux.html" class="nav-link">
  软件安装
</a></li><li class="dropdown-item"><!----> <a href="/tools/bugRepository/03_MySQL主从复制Bug.html" class="nav-link">
  bug库
</a></li><li class="dropdown-item"><!----> <a href="/tools/other/07_打包插件maven-assembly-plugin.html" class="nav-link">
  其他
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/interview/" class="nav-link">
  面试
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/01_ProgrammingBasic/link.html" class="nav-link">
  编程基础
</a></li><li class="dropdown-item"><!----> <a href="/java/02_DevelopmentTools/link.html" class="nav-link">
  开发工具
</a></li><li class="dropdown-item"><!----> <a href="/java/03_ApplicationFramework/link.html" class="nav-link">
  应用框架
</a></li><li class="dropdown-item"><!----> <a href="/java/04_OperationAndMaintenance/" class="nav-link">
  运维
</a></li><li class="dropdown-item"><!----> <a href="/java/05_SourceCode/" class="nav-link">
  源码
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/web/01_vue/使用webpack打包一个简单的前端程序.html" class="nav-link">
  vue
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具箱" class="dropdown-title"><span class="title">工具箱</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具箱" class="mobile-dropdown-title"><span class="title">工具箱</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/tools/essay/04_SpringBoot中处理跨域的几种方式.html" class="nav-link">
  随笔
</a></li><li class="dropdown-item"><!----> <a href="/tools/installSoftware/01_jdk_linux.html" class="nav-link">
  软件安装
</a></li><li class="dropdown-item"><!----> <a href="/tools/bugRepository/03_MySQL主从复制Bug.html" class="nav-link">
  bug库
</a></li><li class="dropdown-item"><!----> <a href="/tools/other/07_打包插件maven-assembly-plugin.html" class="nav-link">
  其他
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>编程基础</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/java/01_ProgrammingBasic/01_JavaLanguage/01_LanguageBasic/01_Java8新特性.html" class="sidebar-link">java8新特性</a></li><li><a href="/java/01_ProgrammingBasic/01_JavaLanguage/01_LanguageBasic/02_Java集合.html" class="sidebar-link">Java 集合</a></li><li><a href="/java/01_ProgrammingBasic/01_JavaLanguage/01_LanguageBasic/03_反射.html" class="sidebar-link">反射</a></li><li><a href="/java/01_ProgrammingBasic/01_JavaLanguage/01_LanguageBasic/IO/01_BIO.html" class="sidebar-link">Java-BIO</a></li><li><a href="/java/01_ProgrammingBasic/01_JavaLanguage/01_LanguageBasic/IO/02_NIO.html" class="sidebar-link">Java-NIO</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JVM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>多线程&amp;高并发</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JDK_Tools</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="volatile与java内存模型"><a href="#volatile与java内存模型" class="header-anchor">#</a> Volatile与Java内存模型</h1> <p>被Volatile修饰的变量有两大特点：可见性与有序性（禁止重排）</p> <p>Volatile的内存语义：</p> <ol><li>当写一个volatile变量时，JMM会把该线程对应的本地内存中的共享变量值<strong>立即刷新回主内存中</strong>。</li> <li>当读一个volatile变量时，JMM会把该线程对应的本地内存设置为无效，<strong>直接从主内存中读取共享变量</strong></li> <li>所以volatile的写内存语义是直接刷新到主内存中，读的内存语义是直接从主内存中读取。</li></ol> <h2 id="一、内存屏障"><a href="#一、内存屏障" class="header-anchor">#</a> 一、内存屏障</h2> <p>内存屏障（也称内存栅栏，内存栅障，屏障指令等，是一类同步屏障指令，是CPU或编译器在对内存随机访问的操作中的一个同步点，使得此点之前的所有读写操作都执行后才可以开始执行此点之后的操作），避免代码重排序。内存屏障其实就是一种JVM指令，<strong>Java内存模型的重排规则会要求Java编译器在生成JVM指令时插入特定的内存屏障指令</strong>，通过这些内存屏障指令，volatile实现了Java内存模型中的可见性和有序性，但volatile无法保证原子性。</p> <p><strong>内存屏障之前的所有写操作都要回写到主内存，</strong> <strong>内存屏障之后的所有读操作都能获得内存屏障之前的所有写操作的最新结果(实现了可见性)。</strong></p> <p><a data-fancybox="" title="image-20210413220212397" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/a017bc4a51c34a3381fd06b4c9b349ee.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/a017bc4a51c34a3381fd06b4c9b349ee.png" alt="image-20210413220212397"></a></p> <p>因此重排序时，不允许把内存屏障之后的指令重排序到内存屏障之前。
一句话：<strong>对一个 volatile 域的写, happens-before 于任意后续对这个 volatile 域的读，也叫写后读。</strong></p> <p>Volatile为什么可以保证可见性和有序性？</p> <p>答：<strong>因为有内存屏障（Memory Barriers / Fences）</strong></p> <p>JVM中提供了四类内存屏障指令：</p> <p><strong>JMM中规定的happens-before先行发生原则，类似接口规范，具体的实现靠的是内存屏障</strong></p> <p>源码：</p> <p>Unsafe.class</p> <p><a data-fancybox="" title="image-20210413220736629" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/1839e644df1f4c7789754212208cd4b3.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/1839e644df1f4c7789754212208cd4b3.png" alt="image-20210413220736629"></a></p> <p>Unsafe.java</p> <p><a data-fancybox="" title="image-20210413220759237" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/052d383c5886410583f40c683dca5d76.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/052d383c5886410583f40c683dca5d76.png" alt="image-20210413220759237"></a></p> <p>Unsafe.cpp</p> <p><a data-fancybox="" title="image-20210413220815909" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/a6dfb06431d047fa8ced5ab640b9ffce.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/a6dfb06431d047fa8ced5ab640b9ffce.png" alt="image-20210413220815909"></a></p> <p>OrderAccess.hpp</p> <p><a data-fancybox="" title="image-20210413220838932" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/3c9459b36d0b42e28b2d560907019dd8.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/3c9459b36d0b42e28b2d560907019dd8.png" alt="image-20210413220838932"></a></p> <p>orderAccess_linux_x86.inline.hpp</p> <p><a data-fancybox="" title="image-20210413220857185" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/06ccdf6bd1304ecf81e0ee7083f73bce.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/06ccdf6bd1304ecf81e0ee7083f73bce.png" alt="image-20210413220857185"></a></p> <p><strong>四大内存屏障具体含义：</strong></p> <p><a data-fancybox="" title="image-20210413220944405" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/87c6a9d1eb6b45e8843e9a55beb7356c.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/87c6a9d1eb6b45e8843e9a55beb7356c.png" alt="image-20210413220944405"></a></p> <p><strong>happens-before之Volatile变量规则</strong></p> <p><a data-fancybox="" title="image-20210413224043880" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/ca49b80b92d74a0b803ce16ad4357ec6.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/ca49b80b92d74a0b803ce16ad4357ec6.png" alt="image-20210413224043880"></a></p> <p><a data-fancybox="" title="image-20210413224056462" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/66eedfb2405a4bb48ccf83db6754f7d3.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/66eedfb2405a4bb48ccf83db6754f7d3.png" alt="image-20210413224056462"></a></p> <p>JMM中关于内存屏障的4种插入策略</p> <p><strong>写：</strong></p> <ol><li><strong>在每个 volatile 写操作的前⾯插⼊⼀个 StoreStore 屏障</strong></li> <li><strong>在每个 volatile 写操作的后⾯插⼊⼀个 StoreLoad 屏障</strong></li></ol> <p><a data-fancybox="" title="image-20210413224637080" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/3201ffad3d844a648025867d6916dd2f.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/3201ffad3d844a648025867d6916dd2f.png" alt="image-20210413224637080"></a></p> <p><a data-fancybox="" title="image-20210413224646669" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/8ca36b3a89f34e0d802f73c32cf1edc8.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/8ca36b3a89f34e0d802f73c32cf1edc8.png" alt="image-20210413224646669"></a></p> <p><strong>读：</strong></p> <ol><li><strong>在每个 volatile 读操作的后⾯插⼊⼀个 LoadLoad 屏障</strong></li> <li><strong>在每个 volatile 读操作的后⾯插⼊⼀个 LoadStore 屏障</strong></li></ol> <p><a data-fancybox="" title="image-20210413224558041" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/a4baf99c354c479481d6cffdab3a9646.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/a4baf99c354c479481d6cffdab3a9646.png" alt="image-20210413224558041"></a></p> <p><a data-fancybox="" title="image-20210413224607247" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/2de790470fa34b4289df95a273051585.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/2de790470fa34b4289df95a273051585.png" alt="image-20210413224607247"></a></p> <h2 id="二、volatile的特性"><a href="#二、volatile的特性" class="header-anchor">#</a> 二、Volatile的特性</h2> <h3 id="_2-1-保证可见性"><a href="#_2-1-保证可见性" class="header-anchor">#</a> 2.1 保证可见性</h3> <p><strong>保证不同线程对这个变量进行操作时的可见性，即变量一旦改变所有线程立即可见</strong></p> <p>示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VolatileDemo</span> <span class="token punctuation">{</span>
    <span class="token comment">// 没有volatile修饰，没有可见性</span>
    <span class="token comment">//static boolean flag = true;</span>

    <span class="token comment">// 加了volatile修饰，保证可见性</span>
    <span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">new</span> <span class="token class-name">Integer</span><span class="token punctuation">(</span><span class="token number">308</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; 程序结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Thread1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>MILLISECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>不加Volatile，没有可见性，程序无法停止</li> <li>加了Volatile，保证了可见性，程序可以停止</li></ul> <p><strong>在没有使用Volatile的情况下，为什么Thread1线程看不到flag的改变，原理解释：</strong></p> <p>可能原因：</p> <ol><li>主线程修改了<code>flag</code>的值后，没有将最新值刷新到主内存，所以<code>Thread1</code>线程看不到</li> <li>主线程已经将<code>flag</code>的最新值刷新到主内存中，但是<code>Thread1</code>线程一直读取的自己工作内存中的值，所以看不到<code>flag</code>修改后的值。</li></ol> <p>需求：</p> <ol><li>多线程中，某个线程修改了共享变量，需要立即将修改后的值刷新到主内存中</li> <li>每个线程，如果需要使用共享变量，每次都要从共享内存中读取最新值，并拷贝到自己的工作内存</li></ol> <p>解决办法：</p> <ol><li>使用Volatile修饰共享变量，就能满足上面的需求，被Volatile修饰的共享变量，具有以下特点</li> <li>每个线程读取共享变量时，都会从主内存中读取最新的值，并将其拷贝到自己的工作内存中</li> <li>每个线程修改了自己工作内存中的共享变量副本，都会立即将副本刷新到主内存</li></ol> <p><strong>Volatile变量的读写过程</strong></p> <p><strong>Java内存模型中定义的8种工作内存与主内存之间的原子操作</strong></p> <p><strong>read(读取)→load(加载)→use(使用)→assign(赋值)→store(存储)→write(写入)→lock(锁定)→unlock(解锁)</strong></p> <p>此处的lock与unlock并不是juc里面的，这是操作系统底层的</p> <p><a data-fancybox="" title="image-20210413230515150" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/b48e7b2d3fed43958a8eaab506524c45.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-13/b48e7b2d3fed43958a8eaab506524c45.png" alt="image-20210413230515150"></a></p> <ol><li>read: <strong>作用于主内存</strong>，将变量的值从主内存传输到工作内存，主内存到工作内存</li> <li>load: 作用于工作内存，将read从主内存传输的变量值放入工作内存变量副本中，即数据加载</li> <li>use: 作用于工作内存，将工作内存变量副本的值传递给执行引擎，每当JVM遇到需要该变量的字节码指令时会执行该操作</li> <li>assign: 作用于工作内存，将从执行引擎接收到的值赋值给工作内存变量，每当JVM遇到一个给变量赋值字节码指令时会执行该操作</li> <li>store: 作用于工作内存，将赋值完毕的工作变量的值写回给主内存</li> <li>write: <strong>作用于主内存</strong>，将store传输过来的变量值赋值给主内存中的变量
<strong>由于上述只能保证单条指令的原子性，针对多条指令的组合性原子保证，没有大面积加锁，所以，JVM提供了另外两个原子指令：</strong></li> <li>lock: <strong>作用于主内存</strong>，将一个变量标记为一个线程独占的状态，只是写时候加锁，就只是锁了写变量的过程。</li> <li>unlock: <strong>作用于主内存</strong>，把一个处于锁定状态的变量释放，然后才能被其他线程占用</li></ol> <h3 id="_2-2-没有原子性"><a href="#_2-2-没有原子性" class="header-anchor">#</a> 2.2 没有原子性</h3> <p><strong>Volatile变量的复合操作（i++）不具有原子性</strong></p> <p>示例：</p> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">.</span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VolatileNoAtomicDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token class-name">MyNumber</span> myNumber <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    myNumber<span class="token punctuation">.</span><span class="token function">addPlusPlus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>myNumber<span class="token punctuation">.</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MyNumber</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addPlusPlus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        number<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>字节码：</p> <p><a data-fancybox="" title="image-20210414000926928" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/71b3f8c2f565479a87c2523f37fdba6d.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/71b3f8c2f565479a87c2523f37fdba6d.png" alt="image-20210414000926928"></a></p> <p><strong>原子性指的是一个操作是不可中断的</strong>，即使是在多线程环境下，一个操作一旦开始就不会被其他线程影响。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token comment">//不具备原子性，该操作是先读取值，然后写回一个新值，相当于原来的值加上1，分3步完成</span>
 <span class="token punctuation">}</span>
</code></pre></div><p><strong>如果第二个线程在第一个线程读取旧值和写回新值期间读取 <code>i</code> 的域值</strong>，那么第二个线程就会与第一个线程一起看到同一个值，并执行相同值的加1操作，这也就造成了线程安全失败，因此对于 <code>add</code> 方法必须使用<code>synchronized</code> 修饰，以便保证线程安全.</p> <p><a data-fancybox="" title="image-20210414001108459" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/8bf9ef93d497469084eae72a82da4578.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/8bf9ef93d497469084eae72a82da4578.png" alt="image-20210414001108459"></a></p> <p>多线程环境下，&quot;数据计算&quot;和&quot;数据赋值&quot;操作可能多次出现，即操作非原子。若数据在加载之后，若主内存count变量发生修改之后，由于线程工作内存中的值在此前已经加载，从而不会对变更操作做出相应变化，即私有内存和公共内存中变量不同步，进而导致数据不一致
对于volatile变量，JVM只是保证从主内存加载到线程工作内存的值是最新的，也就是数据加载时是最新的。
<strong>由此可见volatile解决的是变量读时的可见性问题，但无法保证原子性，对于多线程修改共享变量的场景必须使用加锁同步</strong></p> <p>读取复制一个普通变量的情况：当线程1对主内存对象发起read操作到write操作第一套流程的时间里，线程2随时都有可能对这个主内存对象发起第二套操作</p> <p><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/a467d00c2bd84f0a8af365bbe614cad7.png" alt="image-20210414235253426"></p> <p>既然使用Volatile修饰的变量，一旦某个线程修改后，其他线程在使用的时候都会读取最新值，为什么不保证原子性？</p> <p>因为Volatile对其中部分指令做了处理：</p> <p>要use(使用)一个变量的时候必需load(载入），要载入的时候必需从主内存read(读取）这样就解决了读的可见性（每次都读取最新的）。</p> <p>写操作是把assign和store做了关联(在assign(赋值)后必需store(存储))。store(存储)后write(写入)。
也就是做到了给一个变量赋值的时候一串关联指令直接把变量值写到主内存。</p> <p>就这样通过使用的时候直接从主内存取，在赋值到直接写回主内存做到了内存可见性。</p> <p>但是在使用（use）和赋值（assign）中间，存在一个间隙，导致了Volatile不能保证原子性</p> <p><a data-fancybox="" title="image-20210414001742516" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/93fe067173f24ac58f24920d4abe473f.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/93fe067173f24ac58f24920d4abe473f.png" alt="image-20210414001742516"></a></p> <p>读取一个Volatile变量的情况</p> <p><a data-fancybox="" title="image-20210414001815364" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/399d07cabf0f4bbd86c1baffd2dcff30.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/399d07cabf0f4bbd86c1baffd2dcff30.png" alt="image-20210414001815364"></a></p> <p><code>read-load-use</code> 和 <code>assign-store-write</code> 成为了两个不可分割的原子操作，<strong>但是在use和assign之间依然有极小的一段真空期</strong>，有可能变量会被其他线程读取，导致写丢失一次</p> <p>但是无论在哪一个时间点主内存的变量和任一工作内存的变量的值都是相等的。这个特性就导致了volatile变量不适合参与到依赖当前值的运算，如<code>i = i + 1; i++;</code>之类的那么依靠可见性的特点。volatile可以用在哪些地方呢？ <strong>通常volatile用做保存某个状态的boolean值or int值</strong>。
《深入理解Java虚拟机》提到：</p> <p><a data-fancybox="" title="image-20210414002009198" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/a3e06413bb7b4c0e873dfa580465fe06.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/a3e06413bb7b4c0e873dfa580465fe06.png" alt="image-20210414002009198"></a></p> <p>面试：为什么Volatile不保证原子性？</p> <p>答：<strong>JVM的字节码，i++分成三步，间隙期不同步非原子操作(i++)</strong></p> <p><a data-fancybox="" title="image-20210414002200327" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/842815b6b64643de868bbbec216f4c0f.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/842815b6b64643de868bbbec216f4c0f.png" alt="image-20210414002200327"></a></p> <p><a data-fancybox="" title="image-20210414002219509" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/a64edd4cfab24d0489ba8e1bcf0986cf.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/a64edd4cfab24d0489ba8e1bcf0986cf.png" alt="image-20210414002219509"></a></p> <h3 id="_2-3-指令禁重排"><a href="#_2-3-指令禁重排" class="header-anchor">#</a> 2.3 指令禁重排</h3> <p>重排序是指编译器和处理器为了优化程序性能而对指令序列进行重新排序的一种手段，有时候会改变程序语句的先后顺序
<strong>不存在数据依赖关系，可以重排序；</strong> <strong>存在数据依赖关系，禁止重排序</strong>
**但重排后的指令绝对不能改变原有的串行语义！**这点在并发设计中必须要重点考虑！</p> <p>重排序的分类和执行流程</p> <p><a data-fancybox="" title="image-20210414002542157" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/14a70ae4b7b94d1e89d65d8dca47e552.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/14a70ae4b7b94d1e89d65d8dca47e552.png" alt="image-20210414002542157"></a></p> <p><strong>编译器优化的重排序</strong>： 编译器在不改变单线程串行语义的前提下，可以重新调整指令的执行顺序
<strong>指令级并行的重排序</strong>： 处理器使用指令级并行技术来将多条指令重叠执行，若不存在数据依赖性，处理器可以改变语句对应机器指令的执行顺序
<strong>内存系统的重排序</strong>： 由于处理器使用缓存和读/写缓冲区，这使得加载和存储操作看上去可能是乱序执行</p> <p><strong>数据依赖性</strong>：若两个操作访问同一变量，且这两个操作中有一个为写操作，此时两操作间就存在数据依赖性。</p> <p>案例 ：</p> <p><strong>不存在数据依赖关系，可以重排序</strong></p> <p><a data-fancybox="" title="image-20210414002743094" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/abe6c8fd9ba44a608b693c1106304b60.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/abe6c8fd9ba44a608b693c1106304b60.png" alt="image-20210414002743094"></a></p> <p><strong>存在数据依赖关系，禁止重排序</strong>===&gt; <strong>重排序发生，会导致程序运行结果不同</strong>。</p> <p>编译器和处理器在重排序时，会遵守数据依赖性，不会改变存在依赖关系的两个操作的执行,但不同处理器和不同线程之间的数据不会被编译器和处理器考虑，其只会作用于单处理器和单线程环境，下面三种情况，只要重排序两个操作的执行顺序，程序的执行结果就会被改变。</p> <p><a data-fancybox="" title="image-20210414002813391" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/3b8e04ff3b5743b5820f346c12c7de8f.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/3b8e04ff3b5743b5820f346c12c7de8f.png" alt="image-20210414002813391"></a></p> <p><strong>Volatile的底层是通过内存屏障来实现禁止指令重排的</strong></p> <p>Volatile有关的禁止指令重排的行为</p> <p><a data-fancybox="" title="image-20210414003000050" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/b93f19c309f740c48be12d404802a5e3.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/b93f19c309f740c48be12d404802a5e3.png" alt="image-20210414003000050"></a></p> <p><a data-fancybox="" title="image-20210414003008411" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/e6f84aca5a5f4e348e5b898deb0d29d0.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/e6f84aca5a5f4e348e5b898deb0d29d0.png" alt="image-20210414003008411"></a></p> <p><strong>四大屏障的插入情况</strong></p> <ol><li><p>在每一个volatile写操作前面插入一个StoreStore屏障</p> <p>StoreStore屏障可以保证在volatile写之前，其前面的所有普通写操作都已经刷新到主内存中。</p></li> <li><p>在每一个volatile写操作后面插入一个StoreLoad屏障</p> <p>StoreLoad屏障的作用是避免volatile写与后面可能有的volatile读/写操作重排序</p></li> <li><p>在每一个volatile读操作后面插入一个LoadLoad屏障</p> <p>LoadLoad屏障用来禁止处理器把上面的volatile读与下面的普通读重排序。</p></li> <li><p>在每一个volatile读操作后面插入一个LoadStore屏障</p> <p>LoadStore屏障用来禁止处理器把上面的volatile读与下面的普通写重排序。</p></li></ol> <p><strong>案例：</strong></p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">//模拟一个单线程，什么顺序读？什么顺序写？</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VolatileTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        i <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
        flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;---i = &quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><a data-fancybox="" title="image-20210414003609061" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/7d114d477f604f60850c36b3aba78354.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/7d114d477f604f60850c36b3aba78354.png" alt="image-20210414003609061"></a></p> <h2 id="三、如何正确使用volatile"><a href="#三、如何正确使用volatile" class="header-anchor">#</a> 三、如何正确使用Volatile</h2> <ol><li><p>单一赋值可以，但是符合运算赋值不可以（例如：i++运算）</p> <ul><li>`volatile int a = 10``</li> <li><code>volatile boolean flag = false</code></li></ul></li> <li><p>判断标志，判断业务是否结束</p> <p>当flag标志位的状态改变后，其他线程会立刻得到最新的值，并作出相应的改变</p> <div class="language-java extra-class"><pre class="language-java"><code>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent</span><span class="token punctuation">.</span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 使用：作为一个布尔状态标志，用于指示发生了一个重要的一次性事件，例如完成初始化或任务结束
 * 理由：状态标志并不依赖于程序内任何其他状态，且通常只有一种状态转换
 * 例子：判断业务是否结束
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UseVolatileDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// do something</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">// update flag status</span>
            flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>开销较低的读，写锁策略</p> <p>读多写少</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 使用：当读远多于写，结合使用内部锁和 volatile 变量来减少同步的开销
 * 理由：利用volatile保证读取操作的可见性；利用synchronized保证复合操作的原子性
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UseVolatileDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 利用Volatile保证读操作的可见性
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 利用Synchronized保证符合操作的原子性
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">int</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>DCL双端锁的发布</p> <p>问题代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SafeDoubleCheckSingleton</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">SafeDoubleCheckSingleton</span> singleton<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 单例，构造方法私有化
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">SafeDoubleCheckSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 单例，双检锁
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SafeDoubleCheckSingleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1、初步判断singleton是否为空</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>singleton <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 2、多线程环境下，创建对象时，为了保证只有一个线程来创建对象，需要加锁</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">SafeDoubleCheckSingleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 3、隐患：多线程环境下，由于编译器的优化，存在指令重排</span>
                <span class="token comment">// 可能对象还未完成初始化就被其他线程读取</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>singleton <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    singleton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SafeDoubleCheckSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> singleton<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>单线程环境下，创建对象的过程如下，此情况下能保证线程获取到已经初始化的实例</p> <p><a data-fancybox="" title="image-20210414212044641" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/e2c3e5ddcf2847708f6b8f254db15324.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/e2c3e5ddcf2847708f6b8f254db15324.png" alt="image-20210414212044641"></a></p> <p>在多线程环境下，由于编译器的优化，存在指令重排序，可能会导致线程获取到还未初始化的对象</p> <p><a data-fancybox="" title="image-20210414212222756" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/1b0d33eb636c401d8d57f4a4a5272d57.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/1b0d33eb636c401d8d57f4a4a5272d57.png" alt="image-20210414212222756"></a></p> <p>解决方法：</p> <ol><li><p>使用Volatile关键字修饰变量</p> <p>使用Volatile关键字修饰的变量，其创建对象的三个步骤，不会被编译器重排，依次来保证线程获取到的对象是初始化后的</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token class-name">SafeDoubleCheckSingleton</span> singleton<span class="token punctuation">;</span>
</code></pre></div></li> <li><p>使用静态内部类</p> <p>不使用Volatile，也可以达到相同的效果</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SafeDoubleCheckSingleton</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">SafeDoubleCheckSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 类加载器在加载类的时候，会加锁，保证一个类只由一个线程来加载
     * 所以SingletonHandleClass只会加载一次
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">SingletonHandleClass</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">SafeDoubleCheckSingleton</span> singleton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SafeDoubleCheckSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">SafeDoubleCheckSingleton</span> <span class="token function">getSingleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">SingletonHandleClass</span><span class="token punctuation">.</span>singleton<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol></li></ol> <h2 id="四、总结"><a href="#四、总结" class="header-anchor">#</a> 四、总结</h2> <h3 id="_4-1-内存屏障是什么"><a href="#_4-1-内存屏障是什么" class="header-anchor">#</a> 4.1 内存屏障是什么</h3> <p><a data-fancybox="" title="image-20210414215128413" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/8929b15d117a488e80f18458aa8c3772.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/8929b15d117a488e80f18458aa8c3772.png" alt="image-20210414215128413"></a></p> <h3 id="_4-2-内存屏障能干嘛"><a href="#_4-2-内存屏障能干嘛" class="header-anchor">#</a> 4.2 内存屏障能干嘛</h3> <ol><li>阻止屏障两边的指令重排序</li> <li>写数据时加入屏障，强制将线程私有工作内存的数据刷回主物理内存</li> <li>读数据时加入屏障，线程私有工作内存的数据失效，重新到主物理内存中获取最新数据</li></ol> <h3 id="_4-3-内存屏障四大指令"><a href="#_4-3-内存屏障四大指令" class="header-anchor">#</a> 4.3 内存屏障四大指令</h3> <ol><li><p>在每一个volatile写操作前面插入一个StoreStore屏障</p> <p><a data-fancybox="" title="image-20210414215324869" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/e67da17822bf483281479dccfd3b2b65.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/e67da17822bf483281479dccfd3b2b65.png" alt="image-20210414215324869"></a></p></li> <li><p>在每一个volatile写操作后面插入一个StoreLoad屏障</p> <p><a data-fancybox="" title="image-20210414215344348" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/8638244da93e40c78d563a4c8c53319e.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/8638244da93e40c78d563a4c8c53319e.png" alt="image-20210414215344348"></a></p></li> <li><p>在每一个volatile读操作后面插入一个LoadLoad屏障</p> <p><a data-fancybox="" title="image-20210414215402098" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/52162483daaf4d8d8c3abff07d832345.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/52162483daaf4d8d8c3abff07d832345.png" alt="image-20210414215402098"></a></p></li> <li><p>在每一个volatile读操作后面插入一个LoadStore屏障</p> <p><a data-fancybox="" title="image-20210414215419435" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/95e3e4bc44d94d1e8d2aabff6f2a9526.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/95e3e4bc44d94d1e8d2aabff6f2a9526.png" alt="image-20210414215419435"></a></p></li></ol> <h3 id="_4-4-volatile与内存屏障"><a href="#_4-4-volatile与内存屏障" class="header-anchor">#</a> 4.4 Volatile与内存屏障</h3> <p>凭什么我们java写了一个volatile关键字，系统底层就加入了内存屏障？两者关系怎么勾搭上的?</p> <p>字节码层面：</p> <p><a data-fancybox="" title="image-20210414215838958" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/3174c5e503b74caa84d5f7de643cd8a3.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/3174c5e503b74caa84d5f7de643cd8a3.png" alt="image-20210414215838958"></a></p> <p><a data-fancybox="" title="image-20210414215854792" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/1b38b8e5fc844f368b17e28940af12cd.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/1b38b8e5fc844f368b17e28940af12cd.png" alt="image-20210414215854792"></a></p> <h3 id="_4-5-volatile可见性"><a href="#_4-5-volatile可见性" class="header-anchor">#</a> 4.5 Volatile可见性</h3> <p><a data-fancybox="" title="image-20210414215952147" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/db8c27f00c384853882c0cc67cde01b3.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/db8c27f00c384853882c0cc67cde01b3.png" alt="image-20210414215952147"></a></p> <h3 id="_4-6-volatile禁重排"><a href="#_4-6-volatile禁重排" class="header-anchor">#</a> 4.6 Volatile禁重排</h3> <p><strong>写指令：</strong></p> <p><a data-fancybox="" title="image-20210414220050538" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/6d3aadeff8304e598b2fba5d1e852db2.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/6d3aadeff8304e598b2fba5d1e852db2.png" alt="image-20210414220050538"></a></p> <p><strong>读指令：</strong></p> <p><a data-fancybox="" title="image-20210414220119628" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/38df0f9e86344fdc88d2968347910700.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/38df0f9e86344fdc88d2968347910700.png" alt="image-20210414220119628"></a></p> <h3 id="_4-7-lock与内存屏障"><a href="#_4-7-lock与内存屏障" class="header-anchor">#</a> 4.7 Lock与内存屏障</h3> <p>此处的Lock指的是juc中的Lock接口</p> <p><a data-fancybox="" title="image-20210414220519588" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/69a69813b5a948128a3f3f892c509233.png" style="left:50%;top:50%;"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/69a69813b5a948128a3f3f892c509233.png" alt="image-20210414220519588"></a></p> <h3 id="_4-8-volatile读写禁止重排"><a href="#_4-8-volatile读写禁止重排" class="header-anchor">#</a> 4.8 Volatile读写禁止重排</h3> <p><a data-fancybox="" title="image-20210414220628458" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/e116bb2ed7ad4b92850880e7da0f11c2.png" style="left:50%;top:50%;"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-04-14/e116bb2ed7ad4b92850880e7da0f11c2.png" alt="image-20210414220628458"></a></p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.ba474f6b.js" defer></script><script src="/assets/js/2.92f2819f.js" defer></script><script src="/assets/js/78.09c3bef7.js" defer></script>
  </body>
</html>
