<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>JUC多线程与高并发 | 小游</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon1" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2021-02-18/d687f535b564447e82a3178a4e9b2f8c.jpg">
    <link rel="icon2" href="https://you-blog.oss-cn-shenzhen.aliyuncs.com/typora/2021-02-18/icon.jpg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.2/jquery.fancybox.min.css">
    <meta name="description" content="知行合一">
    
    <link rel="preload" href="/blog_publish/assets/css/0.styles.de4c7292.css" as="style"><link rel="preload" href="/blog_publish/assets/js/app.8eb0dca0.js" as="script"><link rel="preload" href="/blog_publish/assets/js/2.76e52daf.js" as="script"><link rel="preload" href="/blog_publish/assets/js/30.694d59ca.js" as="script"><link rel="prefetch" href="/blog_publish/assets/js/10.ee8e24dd.js"><link rel="prefetch" href="/blog_publish/assets/js/100.4075bd38.js"><link rel="prefetch" href="/blog_publish/assets/js/101.82d60046.js"><link rel="prefetch" href="/blog_publish/assets/js/102.0a31e5bf.js"><link rel="prefetch" href="/blog_publish/assets/js/103.27f403e3.js"><link rel="prefetch" href="/blog_publish/assets/js/104.4f5077a7.js"><link rel="prefetch" href="/blog_publish/assets/js/105.2092b5e7.js"><link rel="prefetch" href="/blog_publish/assets/js/106.88b9b612.js"><link rel="prefetch" href="/blog_publish/assets/js/107.3188622a.js"><link rel="prefetch" href="/blog_publish/assets/js/108.cee74253.js"><link rel="prefetch" href="/blog_publish/assets/js/109.008ad7e4.js"><link rel="prefetch" href="/blog_publish/assets/js/11.63756cc7.js"><link rel="prefetch" href="/blog_publish/assets/js/110.7416716c.js"><link rel="prefetch" href="/blog_publish/assets/js/111.c953ccaf.js"><link rel="prefetch" href="/blog_publish/assets/js/112.f953a849.js"><link rel="prefetch" href="/blog_publish/assets/js/113.381d0332.js"><link rel="prefetch" href="/blog_publish/assets/js/114.c07221fe.js"><link rel="prefetch" href="/blog_publish/assets/js/115.40fde2ac.js"><link rel="prefetch" href="/blog_publish/assets/js/116.46d3b98c.js"><link rel="prefetch" href="/blog_publish/assets/js/117.d7b68d53.js"><link rel="prefetch" href="/blog_publish/assets/js/118.e5e6ddfb.js"><link rel="prefetch" href="/blog_publish/assets/js/119.1346f5f1.js"><link rel="prefetch" href="/blog_publish/assets/js/12.6a4552ac.js"><link rel="prefetch" href="/blog_publish/assets/js/120.a6ba8583.js"><link rel="prefetch" href="/blog_publish/assets/js/121.ff922fb9.js"><link rel="prefetch" href="/blog_publish/assets/js/122.aa3a5636.js"><link rel="prefetch" href="/blog_publish/assets/js/123.0ed9f31a.js"><link rel="prefetch" href="/blog_publish/assets/js/124.8454632d.js"><link rel="prefetch" href="/blog_publish/assets/js/125.2bf7cfcc.js"><link rel="prefetch" href="/blog_publish/assets/js/126.6add5cc0.js"><link rel="prefetch" href="/blog_publish/assets/js/127.784b0159.js"><link rel="prefetch" href="/blog_publish/assets/js/128.6cbb1332.js"><link rel="prefetch" href="/blog_publish/assets/js/129.0942d484.js"><link rel="prefetch" href="/blog_publish/assets/js/13.dbd23e2f.js"><link rel="prefetch" href="/blog_publish/assets/js/130.429b368a.js"><link rel="prefetch" href="/blog_publish/assets/js/131.b7e207c8.js"><link rel="prefetch" href="/blog_publish/assets/js/132.40a11597.js"><link rel="prefetch" href="/blog_publish/assets/js/133.1ec16d93.js"><link rel="prefetch" href="/blog_publish/assets/js/134.1dc6b4c5.js"><link rel="prefetch" href="/blog_publish/assets/js/135.e48e2df6.js"><link rel="prefetch" href="/blog_publish/assets/js/136.b34b42dc.js"><link rel="prefetch" href="/blog_publish/assets/js/137.1bc45737.js"><link rel="prefetch" href="/blog_publish/assets/js/138.f3a7e07d.js"><link rel="prefetch" href="/blog_publish/assets/js/139.cb37f8b9.js"><link rel="prefetch" href="/blog_publish/assets/js/14.f3e6a511.js"><link rel="prefetch" href="/blog_publish/assets/js/140.d641d110.js"><link rel="prefetch" href="/blog_publish/assets/js/141.d974b0e7.js"><link rel="prefetch" href="/blog_publish/assets/js/142.0454c736.js"><link rel="prefetch" href="/blog_publish/assets/js/143.2147d09a.js"><link rel="prefetch" href="/blog_publish/assets/js/144.8caf1fcf.js"><link rel="prefetch" href="/blog_publish/assets/js/145.3fb2390e.js"><link rel="prefetch" href="/blog_publish/assets/js/146.eef52682.js"><link rel="prefetch" href="/blog_publish/assets/js/147.01ad4d77.js"><link rel="prefetch" href="/blog_publish/assets/js/148.c4b0692e.js"><link rel="prefetch" href="/blog_publish/assets/js/149.13b2aa63.js"><link rel="prefetch" href="/blog_publish/assets/js/15.a0b12c7c.js"><link rel="prefetch" href="/blog_publish/assets/js/150.b9013267.js"><link rel="prefetch" href="/blog_publish/assets/js/151.5d8a1981.js"><link rel="prefetch" href="/blog_publish/assets/js/152.7465a9fc.js"><link rel="prefetch" href="/blog_publish/assets/js/153.3863e7b0.js"><link rel="prefetch" href="/blog_publish/assets/js/154.7d3b920f.js"><link rel="prefetch" href="/blog_publish/assets/js/155.d1877a56.js"><link rel="prefetch" href="/blog_publish/assets/js/156.3b9d625d.js"><link rel="prefetch" href="/blog_publish/assets/js/157.008db1fe.js"><link rel="prefetch" href="/blog_publish/assets/js/158.bac50688.js"><link rel="prefetch" href="/blog_publish/assets/js/159.8f6e9e58.js"><link rel="prefetch" href="/blog_publish/assets/js/16.6ca02fbc.js"><link rel="prefetch" href="/blog_publish/assets/js/160.45f05b65.js"><link rel="prefetch" href="/blog_publish/assets/js/161.93759847.js"><link rel="prefetch" href="/blog_publish/assets/js/162.153f43be.js"><link rel="prefetch" href="/blog_publish/assets/js/163.f058feac.js"><link rel="prefetch" href="/blog_publish/assets/js/164.e41008c9.js"><link rel="prefetch" href="/blog_publish/assets/js/165.318edbc2.js"><link rel="prefetch" href="/blog_publish/assets/js/166.2547bd22.js"><link rel="prefetch" href="/blog_publish/assets/js/167.0d67f660.js"><link rel="prefetch" href="/blog_publish/assets/js/168.00635d54.js"><link rel="prefetch" href="/blog_publish/assets/js/169.29d3a722.js"><link rel="prefetch" href="/blog_publish/assets/js/17.5a17bea8.js"><link rel="prefetch" href="/blog_publish/assets/js/170.8bb913d8.js"><link rel="prefetch" href="/blog_publish/assets/js/171.7b9c832f.js"><link rel="prefetch" href="/blog_publish/assets/js/172.64ec53a8.js"><link rel="prefetch" href="/blog_publish/assets/js/173.2ae8c07a.js"><link rel="prefetch" href="/blog_publish/assets/js/174.6195a0e0.js"><link rel="prefetch" href="/blog_publish/assets/js/175.2ce4f07d.js"><link rel="prefetch" href="/blog_publish/assets/js/176.c8c0d8dd.js"><link rel="prefetch" href="/blog_publish/assets/js/177.0bf72607.js"><link rel="prefetch" href="/blog_publish/assets/js/178.627516d4.js"><link rel="prefetch" href="/blog_publish/assets/js/179.4cfdb108.js"><link rel="prefetch" href="/blog_publish/assets/js/18.98988740.js"><link rel="prefetch" href="/blog_publish/assets/js/180.6902f8d7.js"><link rel="prefetch" href="/blog_publish/assets/js/181.c0eb8ec0.js"><link rel="prefetch" href="/blog_publish/assets/js/182.9b826981.js"><link rel="prefetch" href="/blog_publish/assets/js/183.07ae653a.js"><link rel="prefetch" href="/blog_publish/assets/js/184.cc6715da.js"><link rel="prefetch" href="/blog_publish/assets/js/185.880fd832.js"><link rel="prefetch" href="/blog_publish/assets/js/186.06540ac3.js"><link rel="prefetch" href="/blog_publish/assets/js/187.d9848bab.js"><link rel="prefetch" href="/blog_publish/assets/js/188.4fa57af2.js"><link rel="prefetch" href="/blog_publish/assets/js/189.93d1c63a.js"><link rel="prefetch" href="/blog_publish/assets/js/19.d2aede21.js"><link rel="prefetch" href="/blog_publish/assets/js/190.119ad725.js"><link rel="prefetch" href="/blog_publish/assets/js/191.f0254043.js"><link rel="prefetch" href="/blog_publish/assets/js/192.4499df31.js"><link rel="prefetch" href="/blog_publish/assets/js/193.246804d0.js"><link rel="prefetch" href="/blog_publish/assets/js/194.5b02684d.js"><link rel="prefetch" href="/blog_publish/assets/js/195.1f531b6d.js"><link rel="prefetch" href="/blog_publish/assets/js/196.1f5c2656.js"><link rel="prefetch" href="/blog_publish/assets/js/197.fbdcec04.js"><link rel="prefetch" href="/blog_publish/assets/js/198.7cac5d9d.js"><link rel="prefetch" href="/blog_publish/assets/js/199.7871422c.js"><link rel="prefetch" href="/blog_publish/assets/js/20.5dc7fe81.js"><link rel="prefetch" href="/blog_publish/assets/js/200.944109c1.js"><link rel="prefetch" href="/blog_publish/assets/js/201.2517c506.js"><link rel="prefetch" href="/blog_publish/assets/js/202.89319c84.js"><link rel="prefetch" href="/blog_publish/assets/js/203.a6116b5b.js"><link rel="prefetch" href="/blog_publish/assets/js/204.995856e2.js"><link rel="prefetch" href="/blog_publish/assets/js/205.0cae4923.js"><link rel="prefetch" href="/blog_publish/assets/js/206.d3c89ab6.js"><link rel="prefetch" href="/blog_publish/assets/js/207.a23095ff.js"><link rel="prefetch" href="/blog_publish/assets/js/208.f6d5e3de.js"><link rel="prefetch" href="/blog_publish/assets/js/209.c50a6664.js"><link rel="prefetch" href="/blog_publish/assets/js/21.32c632b3.js"><link rel="prefetch" href="/blog_publish/assets/js/210.628279c7.js"><link rel="prefetch" href="/blog_publish/assets/js/211.65b0873b.js"><link rel="prefetch" href="/blog_publish/assets/js/212.229a024e.js"><link rel="prefetch" href="/blog_publish/assets/js/213.8f46ee5d.js"><link rel="prefetch" href="/blog_publish/assets/js/214.f8016ec2.js"><link rel="prefetch" href="/blog_publish/assets/js/215.bc0582d5.js"><link rel="prefetch" href="/blog_publish/assets/js/216.3472bb4d.js"><link rel="prefetch" href="/blog_publish/assets/js/217.47f95af5.js"><link rel="prefetch" href="/blog_publish/assets/js/218.fbf39318.js"><link rel="prefetch" href="/blog_publish/assets/js/219.2deecbe0.js"><link rel="prefetch" href="/blog_publish/assets/js/22.9ee03254.js"><link rel="prefetch" href="/blog_publish/assets/js/220.e35fc6fb.js"><link rel="prefetch" href="/blog_publish/assets/js/221.b8038f93.js"><link rel="prefetch" href="/blog_publish/assets/js/222.25e8f564.js"><link rel="prefetch" href="/blog_publish/assets/js/223.8d614d55.js"><link rel="prefetch" href="/blog_publish/assets/js/224.7dbf23d0.js"><link rel="prefetch" href="/blog_publish/assets/js/225.7bf2b44f.js"><link rel="prefetch" href="/blog_publish/assets/js/226.47b061c6.js"><link rel="prefetch" href="/blog_publish/assets/js/227.3127601a.js"><link rel="prefetch" href="/blog_publish/assets/js/228.3bcfb7fe.js"><link rel="prefetch" href="/blog_publish/assets/js/229.53a9ecd3.js"><link rel="prefetch" href="/blog_publish/assets/js/23.e0a502a7.js"><link rel="prefetch" href="/blog_publish/assets/js/230.e326d338.js"><link rel="prefetch" href="/blog_publish/assets/js/231.9cf0786b.js"><link rel="prefetch" href="/blog_publish/assets/js/232.8e11d23b.js"><link rel="prefetch" href="/blog_publish/assets/js/233.5b736ad8.js"><link rel="prefetch" href="/blog_publish/assets/js/234.b908ddc2.js"><link rel="prefetch" href="/blog_publish/assets/js/235.8885e9ef.js"><link rel="prefetch" href="/blog_publish/assets/js/236.c054bc54.js"><link rel="prefetch" href="/blog_publish/assets/js/237.7c5d8848.js"><link rel="prefetch" href="/blog_publish/assets/js/238.66677ae6.js"><link rel="prefetch" href="/blog_publish/assets/js/239.9cef9c0c.js"><link rel="prefetch" href="/blog_publish/assets/js/24.697094bf.js"><link rel="prefetch" href="/blog_publish/assets/js/240.b7aaeb32.js"><link rel="prefetch" href="/blog_publish/assets/js/241.aa6a79a4.js"><link rel="prefetch" href="/blog_publish/assets/js/242.cdcac74d.js"><link rel="prefetch" href="/blog_publish/assets/js/243.d8bbfad8.js"><link rel="prefetch" href="/blog_publish/assets/js/244.cff1cd47.js"><link rel="prefetch" href="/blog_publish/assets/js/245.b1f74bf1.js"><link rel="prefetch" href="/blog_publish/assets/js/246.823dcc70.js"><link rel="prefetch" href="/blog_publish/assets/js/247.acda5d56.js"><link rel="prefetch" href="/blog_publish/assets/js/248.d74c26d3.js"><link rel="prefetch" href="/blog_publish/assets/js/249.b0072a47.js"><link rel="prefetch" href="/blog_publish/assets/js/25.c73af3b6.js"><link rel="prefetch" href="/blog_publish/assets/js/250.197aff94.js"><link rel="prefetch" href="/blog_publish/assets/js/251.0d543a58.js"><link rel="prefetch" href="/blog_publish/assets/js/252.2da256fe.js"><link rel="prefetch" href="/blog_publish/assets/js/253.e77bf23d.js"><link rel="prefetch" href="/blog_publish/assets/js/254.8eb35c24.js"><link rel="prefetch" href="/blog_publish/assets/js/255.f644e403.js"><link rel="prefetch" href="/blog_publish/assets/js/256.ef28369b.js"><link rel="prefetch" href="/blog_publish/assets/js/257.522be79e.js"><link rel="prefetch" href="/blog_publish/assets/js/258.7ea78042.js"><link rel="prefetch" href="/blog_publish/assets/js/259.bb595095.js"><link rel="prefetch" href="/blog_publish/assets/js/26.c7e8796a.js"><link rel="prefetch" href="/blog_publish/assets/js/260.c11652dc.js"><link rel="prefetch" href="/blog_publish/assets/js/261.939d581e.js"><link rel="prefetch" href="/blog_publish/assets/js/262.7ebda73c.js"><link rel="prefetch" href="/blog_publish/assets/js/263.deb8dc4d.js"><link rel="prefetch" href="/blog_publish/assets/js/264.a23d2e9e.js"><link rel="prefetch" href="/blog_publish/assets/js/265.88a80907.js"><link rel="prefetch" href="/blog_publish/assets/js/266.06138807.js"><link rel="prefetch" href="/blog_publish/assets/js/267.d221d341.js"><link rel="prefetch" href="/blog_publish/assets/js/268.8b742cbd.js"><link rel="prefetch" href="/blog_publish/assets/js/269.deff1605.js"><link rel="prefetch" href="/blog_publish/assets/js/27.de43b212.js"><link rel="prefetch" href="/blog_publish/assets/js/270.34cc37b8.js"><link rel="prefetch" href="/blog_publish/assets/js/271.d5409d40.js"><link rel="prefetch" href="/blog_publish/assets/js/272.4b307453.js"><link rel="prefetch" href="/blog_publish/assets/js/273.fcfe18a8.js"><link rel="prefetch" href="/blog_publish/assets/js/274.36e8a2e8.js"><link rel="prefetch" href="/blog_publish/assets/js/275.63760ab8.js"><link rel="prefetch" href="/blog_publish/assets/js/276.1c4d5144.js"><link rel="prefetch" href="/blog_publish/assets/js/277.9e737d43.js"><link rel="prefetch" href="/blog_publish/assets/js/278.0a5be0bc.js"><link rel="prefetch" href="/blog_publish/assets/js/279.779893b0.js"><link rel="prefetch" href="/blog_publish/assets/js/28.fa2c001d.js"><link rel="prefetch" href="/blog_publish/assets/js/280.063584ed.js"><link rel="prefetch" href="/blog_publish/assets/js/281.52e064b1.js"><link rel="prefetch" href="/blog_publish/assets/js/282.51d82470.js"><link rel="prefetch" href="/blog_publish/assets/js/283.8041bc55.js"><link rel="prefetch" href="/blog_publish/assets/js/284.420c531f.js"><link rel="prefetch" href="/blog_publish/assets/js/285.856478be.js"><link rel="prefetch" href="/blog_publish/assets/js/286.aa11bede.js"><link rel="prefetch" href="/blog_publish/assets/js/287.8c803dcd.js"><link rel="prefetch" href="/blog_publish/assets/js/288.a215566c.js"><link rel="prefetch" href="/blog_publish/assets/js/289.5e93fca3.js"><link rel="prefetch" href="/blog_publish/assets/js/29.707403af.js"><link rel="prefetch" href="/blog_publish/assets/js/290.1dcedc10.js"><link rel="prefetch" href="/blog_publish/assets/js/291.86d22ac2.js"><link rel="prefetch" href="/blog_publish/assets/js/292.03a12640.js"><link rel="prefetch" href="/blog_publish/assets/js/293.47223b3c.js"><link rel="prefetch" href="/blog_publish/assets/js/294.b4dabb1a.js"><link rel="prefetch" href="/blog_publish/assets/js/295.708babd9.js"><link rel="prefetch" href="/blog_publish/assets/js/3.bbab3d51.js"><link rel="prefetch" href="/blog_publish/assets/js/31.7a23cf14.js"><link rel="prefetch" href="/blog_publish/assets/js/32.69850c8b.js"><link rel="prefetch" href="/blog_publish/assets/js/33.8042d09b.js"><link rel="prefetch" href="/blog_publish/assets/js/34.46861115.js"><link rel="prefetch" href="/blog_publish/assets/js/35.a39d6909.js"><link rel="prefetch" href="/blog_publish/assets/js/36.cc45055b.js"><link rel="prefetch" href="/blog_publish/assets/js/37.ddd4a4ef.js"><link rel="prefetch" href="/blog_publish/assets/js/38.23d4f862.js"><link rel="prefetch" href="/blog_publish/assets/js/39.1b0619f6.js"><link rel="prefetch" href="/blog_publish/assets/js/4.f4732439.js"><link rel="prefetch" href="/blog_publish/assets/js/40.de24dcae.js"><link rel="prefetch" href="/blog_publish/assets/js/41.a0bc135f.js"><link rel="prefetch" href="/blog_publish/assets/js/42.fb87e19a.js"><link rel="prefetch" href="/blog_publish/assets/js/43.4c472397.js"><link rel="prefetch" href="/blog_publish/assets/js/44.03a19e3e.js"><link rel="prefetch" href="/blog_publish/assets/js/45.faeed829.js"><link rel="prefetch" href="/blog_publish/assets/js/46.2be7a6e0.js"><link rel="prefetch" href="/blog_publish/assets/js/47.b521e5b7.js"><link rel="prefetch" href="/blog_publish/assets/js/48.a69ac436.js"><link rel="prefetch" href="/blog_publish/assets/js/49.05668fec.js"><link rel="prefetch" href="/blog_publish/assets/js/5.295e6ecd.js"><link rel="prefetch" href="/blog_publish/assets/js/50.e067e986.js"><link rel="prefetch" href="/blog_publish/assets/js/51.dec466d0.js"><link rel="prefetch" href="/blog_publish/assets/js/52.ccd11137.js"><link rel="prefetch" href="/blog_publish/assets/js/53.060b19f7.js"><link rel="prefetch" href="/blog_publish/assets/js/54.cd77b3f1.js"><link rel="prefetch" href="/blog_publish/assets/js/55.6344fd36.js"><link rel="prefetch" href="/blog_publish/assets/js/56.af7bda9c.js"><link rel="prefetch" href="/blog_publish/assets/js/57.72d58233.js"><link rel="prefetch" href="/blog_publish/assets/js/58.be20060e.js"><link rel="prefetch" href="/blog_publish/assets/js/59.49b17dd3.js"><link rel="prefetch" href="/blog_publish/assets/js/6.104e7c0d.js"><link rel="prefetch" href="/blog_publish/assets/js/60.5744dd49.js"><link rel="prefetch" href="/blog_publish/assets/js/61.d6333b8c.js"><link rel="prefetch" href="/blog_publish/assets/js/62.d83ec1cb.js"><link rel="prefetch" href="/blog_publish/assets/js/63.977c0f24.js"><link rel="prefetch" href="/blog_publish/assets/js/64.e2ff7279.js"><link rel="prefetch" href="/blog_publish/assets/js/65.8669dd72.js"><link rel="prefetch" href="/blog_publish/assets/js/66.b4892595.js"><link rel="prefetch" href="/blog_publish/assets/js/67.a375c90a.js"><link rel="prefetch" href="/blog_publish/assets/js/68.ebf8d160.js"><link rel="prefetch" href="/blog_publish/assets/js/69.49764334.js"><link rel="prefetch" href="/blog_publish/assets/js/7.a47169ea.js"><link rel="prefetch" href="/blog_publish/assets/js/70.b06142e9.js"><link rel="prefetch" href="/blog_publish/assets/js/71.10a46134.js"><link rel="prefetch" href="/blog_publish/assets/js/72.6e7c6093.js"><link rel="prefetch" href="/blog_publish/assets/js/73.8354d07f.js"><link rel="prefetch" href="/blog_publish/assets/js/74.66b8eb86.js"><link rel="prefetch" href="/blog_publish/assets/js/75.886b2120.js"><link rel="prefetch" href="/blog_publish/assets/js/76.db5cafa2.js"><link rel="prefetch" href="/blog_publish/assets/js/77.57e84930.js"><link rel="prefetch" href="/blog_publish/assets/js/78.b9f58095.js"><link rel="prefetch" href="/blog_publish/assets/js/79.b379194a.js"><link rel="prefetch" href="/blog_publish/assets/js/8.4b94779e.js"><link rel="prefetch" href="/blog_publish/assets/js/80.ca10481f.js"><link rel="prefetch" href="/blog_publish/assets/js/81.65ba6fd9.js"><link rel="prefetch" href="/blog_publish/assets/js/82.edd13280.js"><link rel="prefetch" href="/blog_publish/assets/js/83.327b2b2e.js"><link rel="prefetch" href="/blog_publish/assets/js/84.d461af84.js"><link rel="prefetch" href="/blog_publish/assets/js/85.88d0588d.js"><link rel="prefetch" href="/blog_publish/assets/js/86.e29637f1.js"><link rel="prefetch" href="/blog_publish/assets/js/87.ef3d0074.js"><link rel="prefetch" href="/blog_publish/assets/js/88.c23e5c16.js"><link rel="prefetch" href="/blog_publish/assets/js/89.59aa1169.js"><link rel="prefetch" href="/blog_publish/assets/js/9.4682d059.js"><link rel="prefetch" href="/blog_publish/assets/js/90.47510fc0.js"><link rel="prefetch" href="/blog_publish/assets/js/91.bd83a25d.js"><link rel="prefetch" href="/blog_publish/assets/js/92.ebca3c79.js"><link rel="prefetch" href="/blog_publish/assets/js/93.77296b1a.js"><link rel="prefetch" href="/blog_publish/assets/js/94.62e92eef.js"><link rel="prefetch" href="/blog_publish/assets/js/95.fd0c4dc7.js"><link rel="prefetch" href="/blog_publish/assets/js/96.08f11356.js"><link rel="prefetch" href="/blog_publish/assets/js/97.ae6724c6.js"><link rel="prefetch" href="/blog_publish/assets/js/98.55e2f4a6.js"><link rel="prefetch" href="/blog_publish/assets/js/99.b2471cba.js">
    <link rel="stylesheet" href="/blog_publish/assets/css/0.styles.de4c7292.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog_publish/" class="home-link router-link-active"><!----> <span class="site-name">小游</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog_publish/interview/" class="nav-link">
  面试
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog_publish/java/01_ProgrammingBasic/link.html" class="nav-link">
  编程基础
</a></li><li class="dropdown-item"><!----> <a href="/blog_publish/java/02_DevelopmentTools/link.html" class="nav-link">
  开发工具
</a></li><li class="dropdown-item"><!----> <a href="/blog_publish/java/03_ApplicationFramework/link.html" class="nav-link">
  应用框架
</a></li><li class="dropdown-item"><!----> <a href="/blog_publish/java/04_OperationAndMaintenance/" class="nav-link">
  运维
</a></li><li class="dropdown-item"><!----> <a href="/blog_publish/java/05_SourceCode/" class="nav-link">
  源码
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog_publish/web/01_vue/使用webpack打包一个简单的前端程序.html" class="nav-link">
  vue
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具箱" class="dropdown-title"><span class="title">工具箱</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具箱" class="mobile-dropdown-title"><span class="title">工具箱</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog_publish/tools/essay/04_SpringBoot中处理跨域的几种方式.html" class="nav-link">
  随笔
</a></li><li class="dropdown-item"><!----> <a href="/blog_publish/tools/installSoftware/01_jdk_linux.html" class="nav-link">
  软件安装
</a></li><li class="dropdown-item"><!----> <a href="/blog_publish/tools/bugRepository/03_MySQL主从复制Bug.html" class="nav-link">
  bug库
</a></li><li class="dropdown-item"><!----> <a href="/blog_publish/tools/other/07_打包插件maven-assembly-plugin.html" class="nav-link">
  其他
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog_publish/interview/" class="nav-link">
  面试
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="后端" class="dropdown-title"><span class="title">后端</span> <span class="arrow down"></span></button> <button type="button" aria-label="后端" class="mobile-dropdown-title"><span class="title">后端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog_publish/java/01_ProgrammingBasic/link.html" class="nav-link">
  编程基础
</a></li><li class="dropdown-item"><!----> <a href="/blog_publish/java/02_DevelopmentTools/link.html" class="nav-link">
  开发工具
</a></li><li class="dropdown-item"><!----> <a href="/blog_publish/java/03_ApplicationFramework/link.html" class="nav-link">
  应用框架
</a></li><li class="dropdown-item"><!----> <a href="/blog_publish/java/04_OperationAndMaintenance/" class="nav-link">
  运维
</a></li><li class="dropdown-item"><!----> <a href="/blog_publish/java/05_SourceCode/" class="nav-link">
  源码
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端" class="dropdown-title"><span class="title">前端</span> <span class="arrow down"></span></button> <button type="button" aria-label="前端" class="mobile-dropdown-title"><span class="title">前端</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog_publish/web/01_vue/使用webpack打包一个简单的前端程序.html" class="nav-link">
  vue
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="工具箱" class="dropdown-title"><span class="title">工具箱</span> <span class="arrow down"></span></button> <button type="button" aria-label="工具箱" class="mobile-dropdown-title"><span class="title">工具箱</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/blog_publish/tools/essay/04_SpringBoot中处理跨域的几种方式.html" class="nav-link">
  随笔
</a></li><li class="dropdown-item"><!----> <a href="/blog_publish/tools/installSoftware/01_jdk_linux.html" class="nav-link">
  软件安装
</a></li><li class="dropdown-item"><!----> <a href="/blog_publish/tools/bugRepository/03_MySQL主从复制Bug.html" class="nav-link">
  bug库
</a></li><li class="dropdown-item"><!----> <a href="/blog_publish/tools/other/07_打包插件maven-assembly-plugin.html" class="nav-link">
  其他
</a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>编程基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JVM</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>多线程&amp;高并发</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/01_多线程基础.html" class="sidebar-link">多线程</a></li><li><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/02_多线程进阶.html" class="active sidebar-link">JUC多线程与高并发</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/02_多线程进阶.html#一、volatile关键字" class="sidebar-link">一、Volatile关键字</a></li><li class="sidebar-sub-header"><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/02_多线程进阶.html#二、cas" class="sidebar-link">二、CAS</a></li><li class="sidebar-sub-header"><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/02_多线程进阶.html#三、原子类" class="sidebar-link">三、原子类</a></li><li class="sidebar-sub-header"><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/02_多线程进阶.html#四、线程安全的集合类" class="sidebar-link">四、线程安全的集合类</a></li><li class="sidebar-sub-header"><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/02_多线程进阶.html#五、线程中的锁" class="sidebar-link">五、线程中的锁</a></li><li class="sidebar-sub-header"><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/02_多线程进阶.html#六、线程通信" class="sidebar-link">六、线程通信</a></li><li class="sidebar-sub-header"><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/02_多线程进阶.html#七、阻塞队列" class="sidebar-link">七、阻塞队列</a></li><li class="sidebar-sub-header"><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/02_多线程进阶.html#八、线程池" class="sidebar-link">八、线程池</a></li><li class="sidebar-sub-header"><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/02_多线程进阶.html#九、死锁编码与定位分析" class="sidebar-link">九、死锁编码与定位分析</a></li><li class="sidebar-sub-header"><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/02_多线程进阶.html#十、synchronized与lock的区别" class="sidebar-link">十、Synchronized与Lock的区别</a></li></ul></li><li><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/03_Volatile关键字.html" class="sidebar-link">Volatile关键字</a></li><li><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/04_CAS.html" class="sidebar-link">CAS</a></li><li><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/05_原子类.html" class="sidebar-link">原子类</a></li><li><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/06_线程安全的集合类.html" class="sidebar-link">线程安全的集合类</a></li><li><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/07_锁.html" class="sidebar-link">线程中的锁</a></li><li><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/08_线程通信.html" class="sidebar-link">线程通信</a></li><li><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/09_阻塞队列.html" class="sidebar-link">阻塞队列</a></li><li><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/10_线程池.html" class="sidebar-link">线程池</a></li><li><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/11_死锁编码与定位分析.html" class="sidebar-link">死锁编码与定位分析</a></li><li><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/12_Synchronized与Lock的区别.html" class="sidebar-link">Synchronized与Lock的区别</a></li><li><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/13_AQS.html" class="sidebar-link">AbstractQueuedSynchronizer</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JDK_Tools</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="juc多线程与高并发"><a href="#juc多线程与高并发" class="header-anchor">#</a> JUC多线程与高并发</h1> <h2 id="一、volatile关键字"><a href="#一、volatile关键字" class="header-anchor">#</a> 一、Volatile关键字</h2> <p>定义：Volatile是Java虚拟机提供的轻量级同步机制，其特点是：</p> <ol><li>保证可见性</li> <li>禁止指令重排序</li> <li>不保证原子性</li></ol> <h3 id="_1-1-java内存模型"><a href="#_1-1-java内存模型" class="header-anchor">#</a> 1.1 Java内存模型</h3> <p>JMM（Java内存模型 Java Memory Model，简称JMM）本身是一种抽象的概念，并不真实存在，它描述的是一种规范或规则，通过这组规范定义了程序中各个变量（包括实例字段，静态字段和构成数组对象的元素）的访问方式。</p> <p>JMM关于同步的规定：</p> <ol><li>线程解锁前，必须把共享变量的值刷新回主内存</li> <li>线程加锁前，必须读取主内存的最新值到自己的工作内存</li> <li>加锁与解锁是同一把锁</li></ol> <p>由于JVM运行程序的实体是线程，而每个线程创建时JVM都会为其创建一个工作内存（有些地方称为栈空间），工作内存是每个线程的私有数据区域，而Java内存模型中规定所有变量都存储在主内存，主内存是共享内存区域，所有线程都是可以访问的，但线程对变量的操作（读取赋值等）必须在工作内存中进行，首先要将变量从主内存拷贝到自己的工作内存空间，然后对变量进行操作，操作完成后再将变量写回主内存，不能直接操作主内存中的变量，各个线程的工作内存中存储着主内存中的变量拷贝副本，因此不同的线程间无法访问对方的工作内存，线程间的通信（传值）必须通过主内存来完成，其简要访问过程如下：</p> <p><a data-fancybox="" title="image-20200801203406968" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-01/9aa8c50d21754a318422e52f3c4dcc48.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-01/9aa8c50d21754a318422e52f3c4dcc48.png" alt="image-20200801203406968"></a></p> <h3 id="_1-2-保证可见性"><a href="#_1-2-保证可见性" class="header-anchor">#</a> 1.2 保证可见性</h3> <p>根据Java虚拟机中的JMM，各个线程对主内存中共享变量的操作都是各个线程各自拷贝到自己的工作内存进行操作然后再写回到主内存中。</p> <p>这就可能存在一个线程Thread1修改了共享变量X的值，但还未写回主内存时，另一个线程Thread2又对主内存中同一个共享变量X进行操作，但此时Thread1线程工作内存中共享变量X对线程Thread2来说是不可见的。</p> <p>这种工作内存与主内存同步延迟现象就造成了可见性问题。</p> <p>Volatile关键字保证线程见的可见性，在一个线程修改了变量并刷回主内存后，会通知其他线程更新变量的值。</p> <p>验证Volatile的可见性</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VolatileDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token class-name">MyData</span> myData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; comes in&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// pause the programming</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// update the number value</span>
            myData<span class="token punctuation">.</span><span class="token function">addToFifty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; updated the number value, and the number value is &quot;</span> <span class="token operator">+</span> myData<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Thread1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// In main thread, try to get the number value. If number equals 0, wait.</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>myData<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
        <span class="token comment">// because the volatile's visibility, when thread1 update the number, the main thread can get the value immediately.</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; get the number value is &quot;</span> <span class="token operator">+</span> myData<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">MyData</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">numberPlusPlus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>number<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>number<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addToFifty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>number <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_1-3-不保证原子性"><a href="#_1-3-不保证原子性" class="header-anchor">#</a> 1.3 不保证原子性</h3> <p>在多线程环境下，i++是线程不安全的。在JVM虚拟机中，i++被分解为三个步骤：</p> <ol><li>获取原始值</li> <li>加一</li> <li>将值写回</li></ol> <p>在执行的过程中，就可能会出现Thread1在操作线程的时候，还未将增加后的值写回主内存，其他线程读取了增加前的值。导致最后的结果有误。</p> <p>原子性验证</p> <div class="language-Java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VolatileDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MyData</span> myData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">20</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    myData<span class="token punctuation">.</span><span class="token function">numberPlusPlus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 如果当前运行的线程数大于2，说明还有除main、gc线程以外的线程在运行</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">activeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 主线程礼让，让其他线程先执行</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Finally number value is &quot;</span> <span class="token operator">+</span> myData<span class="token punctuation">.</span><span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">MyData</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">numberPlusPlus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>number<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getNumber</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>number<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addToFifty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>number <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_1-4-保证有序性-禁止指令重排序"><a href="#_1-4-保证有序性-禁止指令重排序" class="header-anchor">#</a> 1.4 保证有序性（禁止指令重排序）</h3> <p>计算机在执行程序时，为了提高性能，编译器和处理器常常会对指令做重排序，一般分一下三种：</p> <p><a data-fancybox="" title="image-20200801213847228" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-01/51ad0e734c634ae08167612c66da8d5f.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-01/51ad0e734c634ae08167612c66da8d5f.png" alt="image-20200801213847228"></a></p> <ol><li>单线程环境里面确保程序最终执行结果和代码顺序执行的结果一致</li> <li>处理器在进行重排序时必须要考虑指令之间的数据依赖性</li> <li>多线程环境中线程交替执行，由于编译器优化重排的存在，两个线程中使用的变量能否保证一致性是无法确定的，结果是无法预测的。</li></ol> <p>volatile实现禁止指令重排优化，从而避免多线程环境下程序出现乱序执行的现象</p> <p>内存屏障（Memory Barrier）：又称为内存栅栏，是一个CPU指令，它的作用有两个：</p> <ol><li>保证特定操作的执行顺序</li> <li>保证某些变量的内存可见性（利用该特性实现Volatile的内存可见性）</li></ol> <p>由于编译器和处理器都能执行指令重排优化。如果在指令间插入一条Memory Barrier则会告诉编译器和Cpu，不管什么指令都不能和这条Memory Barrier指令重排序，也就是说通过内存屏障禁止在内存屏障前后的指令执行重排序优化。内存屏障另一个作用是强制刷出各种CPU的缓存数据，因此任何CPU上的线程都能读取到这些数据的最新版本。</p> <p><a data-fancybox="" title="img" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-01/c87ca4919a384d788e911c390c94e271.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-01/c87ca4919a384d788e911c390c94e271.png" alt="img"></a></p> <h3 id="_1-5-如何保证线程安全"><a href="#_1-5-如何保证线程安全" class="header-anchor">#</a> 1.5 如何保证线程安全</h3> <ol><li>工作内存与主内存同步延迟现象导致的可见性问题：可以使用synchronized或Volatile关键字解决，它们都可以使一个线程修改后的变量立即对其他线程可见。</li> <li>对于指令重排序导致的可见性问题和有序性问题：可以利用Volatile关键字解决，因为Volatile的另一个作用就是禁止重排序优化。</li></ol> <h3 id="_1-6-使用volatile案例"><a href="#_1-6-使用volatile案例" class="header-anchor">#</a> 1.6 使用Volatile案例</h3> <ol><li><p>在单例中的双检锁</p> <p>在单例模式中，使用普通的双检锁模式，不能绝对保证线程安全，因为存在指令重排序。加入Volatile关键字后，可以禁止指令重排序，保证线程安全。</p> <p>初始化对象的步骤：</p> <div class="language- extra-class"><pre class="language-text"><code>new SingletonDemo()；可以分为三步完成：
memory = allocate（） 1. 分配对象内存空间
instance（memory）	2. 初始化对象
instance = memory	3. 设置instance指向刚分配的内存地址，此时instance !=null
</code></pre></div><p>指令重排序：</p> <div class="language- extra-class"><pre class="language-text"><code>步骤2和步骤3不存在数据依赖关系，而且无论重排前还是重排后，程序的执行结果在单线程中没有改变，因此这种重排优化时允许的。
memory = allocate（） 1. 分配对象内存空间
instance = memory	3. 设置instance指向刚分配的内存地址，此时instance !=null
instance（memory）	2. 初始化对象
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SingletonDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token operator">::</span><span class="token function">getInstance</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token class-name">Singleton</span> instance <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; This is construct method&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h2 id="二、cas"><a href="#二、cas" class="header-anchor">#</a> 二、CAS</h2> <h3 id="_2-1-cas-compareandswap"><a href="#_2-1-cas-compareandswap" class="header-anchor">#</a> 2.1 CAS: CompareAndSwap</h3> <p>CAS的全称是Compare-And-Swap，它是一条CPU并发原语。</p> <p>它的功能是判断内存某个位置的值是否为预期值，如果是则更改为新的值，这个过程是原子的。</p> <p>CAS并发原语体现在JAVA语言中就是sun.misc.Unsafe类中的各个方法。调用UnSafe类中的CAS方法，JVM会帮我们实现出CAS汇编指令，这只一种完全依赖于硬件的功能，通过它实现了原子操作。由于CAS是一种系统原语，原语属于操作系统用语范围，是由若干条指令组成的，用于完成某个功能的一个过程，并且原语的执行必须是连续的，在执行过程中不予许被中断，也就是说CAS是一条CPU的原子指令，不会造成所谓的数据不一致问题。</p> <ol><li>各个线程在操作前，先从主内存拷贝变量到各自的工作内存。</li> <li>各个线程在更新变量前（写回主内存），先用上次从主内存中拷贝的变量值与当前主内存中的值比较，如果相等，则更新成功；否则，更新失败。</li> <li>更新成功后，返回更新后的值；更新失败后，返回当前主内存中的值。</li></ol> <h3 id="_2-2-unsafe"><a href="#_2-2-unsafe" class="header-anchor">#</a> 2.2 UnSafe</h3> <p>UnSafe是rt.jar中的一个类。</p> <p><a data-fancybox="" title="img" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-01/79af11bea9bd4fb3877fe6cfc81091c8.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-01/79af11bea9bd4fb3877fe6cfc81091c8.png" alt="img"></a></p> <ol><li><p>UnSafe</p> <p>是CAS的核心类，由于Java方法无法直接访问底层系统，需要通过本地（native）方法来访问，UnSafe相当于一个后门，基于类可以直接操作特定内存的数据。UnSafe类存在于sun.misc包中，其内存方法操作可以像C的指针一样直接操作内存，因为JavaCAS操作的执行依赖于UnSafe类的方法。注意：UnSafe类中的所有方法都是native修饰的，也就是说UnSafe类中的方法都是直接调用操作系统底层资源执行相应任务。</p></li> <li><p>变量valueOffset，表示该变量值在内存中的偏移地址，因为Unsafe就是根据内存偏移地址获取数据的。</p></li></ol> <p><a data-fancybox="" title="img" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-01/2dcc6e4b5bcc47278762514e405df85e.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-01/2dcc6e4b5bcc47278762514e405df85e.png" alt="img"></a></p> <ol start="3"><li>变量value用Volatile修饰，保证了多线程之间的内存可见性</li></ol> <p>在AtomicInteger类中，有两个相似的方法，getAndAdd与addAndGet。不同之处是，addAndGet会在调用getAndAddInt方法后，再加上delta。</p> <h3 id="_2-3-cas缺点"><a href="#_2-3-cas缺点" class="header-anchor">#</a> 2.3 CAS缺点</h3> <ol><li><p>循环时间长，开销很大</p> <p><a data-fancybox="" title="image-20200801224100239" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-01/25b5cab0583745c58f832d74d82962f1.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-01/25b5cab0583745c58f832d74d82962f1.png" alt="image-20200801224100239"></a></p> <p><a data-fancybox="" title="image-20200801224112926" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-01/b8831400eba4465582b13671ebff8261.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-01/b8831400eba4465582b13671ebff8261.png" alt="image-20200801224112926"></a></p> <p>在GetAndAddInt方法中，存在一个do while，如果CAS更新失败，会一直尝试更新，CPU的消耗会很大。</p></li> <li><p>只能保证一个共享变量的原子操作</p> <p>当对一个共享变量执行操作时，可以使用循环CAS的方式，保证原子性；当对多个共享变量操作时，可以使用锁来保证原子性。</p></li> <li><p>存在ABA问题</p> <ol><li>线程A与线程B同时读取主内存中的值：value=3</li> <li>线程A一直在做运算</li> <li>线程B将value更改为4</li> <li>线程B再将value更改为3</li> <li>线程A运算完成，向主内存写回数据，返回主内存中的值为3,以为自己运算期间，没有线程对value进行过更改。这种问题被称为ABA问题，在某些场景下存在安全隐患。</li></ol></li></ol> <h2 id="三、原子类"><a href="#三、原子类" class="header-anchor">#</a> 三、原子类</h2> <h3 id="_3-1-aba问题"><a href="#_3-1-aba问题" class="header-anchor">#</a> 3.1 ABA问题</h3> <ol><li>主内存中存在变量V1，值为A</li> <li>Thread1获取主内存中的变量V1的值并对其进行操作，操作一次时间时10秒钟。</li> <li>Thread2获取主内存中的变量V1的值并对其操作，操作一次是2秒钟。Thread2将V1的值由A变为B，并写回主内存</li> <li>Thread2再次获取变量V1的值，并将其改回为A，写回主内存</li> <li>Thread1操作完成，比较自己操作前的拷贝值与现在主内存中的值，发现没有变化，并将新的值写回主内存</li> <li>在Thread1操作的过程中，Thread2修改过两次变量V1的值，然而Thread1却认为没有变化。在某些情况下，会存在安全隐患</li></ol> <h3 id="_3-2-原子引用"><a href="#_3-2-原子引用" class="header-anchor">#</a> 3.2 原子引用</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicReference</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ABAEvent</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> atomicReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Thread1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">boolean</span> b <span class="token operator">=</span> atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>atomicReference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;thread2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3-3-时间戳原子引用"><a href="#_3-3-时间戳原子引用" class="header-anchor">#</a> 3.3 时间戳原子引用</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ABAEvent</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AtomicStampedReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> reference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicStampedReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ---- &quot;</span> <span class="token operator">+</span> reference<span class="token punctuation">.</span><span class="token function">getStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">int</span> stamp <span class="token operator">=</span> reference<span class="token punctuation">.</span><span class="token function">getStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            reference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">101</span><span class="token punctuation">,</span> stamp<span class="token punctuation">,</span> <span class="token operator">++</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ---- &quot;</span> <span class="token operator">+</span> reference<span class="token punctuation">.</span><span class="token function">getStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            reference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">101</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">,</span> stamp<span class="token punctuation">,</span> <span class="token operator">++</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ---- &quot;</span> <span class="token operator">+</span> reference<span class="token punctuation">.</span><span class="token function">getStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Thread1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> stamp <span class="token operator">=</span> reference<span class="token punctuation">.</span><span class="token function">getStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ---- &quot;</span> <span class="token operator">+</span> reference<span class="token punctuation">.</span><span class="token function">getStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">boolean</span> result <span class="token operator">=</span> reference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">,</span> <span class="token number">2020</span><span class="token punctuation">,</span> stamp<span class="token punctuation">,</span> <span class="token operator">++</span>stamp<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ---- &quot;</span> <span class="token operator">+</span> reference<span class="token punctuation">.</span><span class="token function">getStamp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>reference<span class="token punctuation">.</span><span class="token function">getReference</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Thread2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="四、线程安全的集合类"><a href="#四、线程安全的集合类" class="header-anchor">#</a> 四、线程安全的集合类</h2> <h3 id="_4-1-线程不安全示例"><a href="#_4-1-线程不安全示例" class="header-anchor">#</a> 4.1 线程不安全示例</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testConcurrentModificationException</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>解决方法</p> <h3 id="_4-2-vector"><a href="#_4-2-vector" class="header-anchor">#</a> 4.2 Vector</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testVector</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vector</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-3-synchronizedlist"><a href="#_4-3-synchronizedlist" class="header-anchor">#</a> 4.3 SynchronizedList</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testSynchronizedList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">synchronizedList</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-4-copyonwritearraylist"><a href="#_4-4-copyonwritearraylist" class="header-anchor">#</a> 4.4 CopyOnWriteArrayList</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testCopyOnWriteArrayList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>写时复制源码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">E</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在添加元素之前，先上锁</span>
    <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lock<span class="token punctuation">;</span>
    lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 获取当前集合中的所有元素</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> elements <span class="token operator">=</span> <span class="token function">getArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取集合长度</span>
        <span class="token keyword">int</span> len <span class="token operator">=</span> elements<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token comment">// 开辟一个新的集合，空间加一，并将原来的集合元素拷贝到newElements中</span>
        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> newElements <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">copyOf</span><span class="token punctuation">(</span>elements<span class="token punctuation">,</span> len <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 将新元素添加到newElements中</span>
        newElements<span class="token punctuation">[</span>len<span class="token punctuation">]</span> <span class="token operator">=</span> e<span class="token punctuation">;</span>
        <span class="token comment">// 更新原来的集合</span>
        <span class="token function">setArray</span><span class="token punctuation">(</span>newElements<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token comment">// 释放锁</span>
        lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-5-copyonwritearrayset"><a href="#_4-5-copyonwritearrayset" class="header-anchor">#</a> 4.5 CopyOnWriteArraySet</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testCopyOnWriteArraySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyOnWriteArraySet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>set<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_4-6-concurrenthashmap"><a href="#_4-6-concurrenthashmap" class="header-anchor">#</a> 4.6 ConcurrentHashMap</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">testConcurrentHashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConcurrentHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="五、线程中的锁"><a href="#五、线程中的锁" class="header-anchor">#</a> 五、线程中的锁</h2> <h3 id="_5-1-公平与非公平锁"><a href="#_5-1-公平与非公平锁" class="header-anchor">#</a> 5.1 公平与非公平锁</h3> <p>公平锁：是指多个线程按照申请锁的顺序来获取锁，类似排队，FIFO。</p> <p>非公平锁：是指多个线程获取锁的顺序并不是按照申请锁的顺序，有可能后申请的线程比先申请的线程优先获取锁。在高并发的情况下，有可能会造成优先级反转或者饥饿现象。其优点是，吞吐量大于非公平锁。</p> <p>在并发包中的ReentrantLock，可以通过执行构造函数中的参数，来指定当前创建的锁的类型，默认为非公平锁。</p> <p>Synchronized是一种非公平锁。</p> <h3 id="_5-2-可重入锁-递归锁"><a href="#_5-2-可重入锁-递归锁" class="header-anchor">#</a> 5.2 可重入锁（递归锁）</h3> <p>指的是同一线程外层函数获得锁之后，内层函数仍然能获取该锁的代码，在同一个线程，在外层方法获取锁的时候，在进入内层方法会自动获取锁。也就是说，线程可以进入任何一个它已经拥有的锁所同步的代码块。可重入锁最大的作用就是能避免死锁。</p> <p>ReentrantLock重入锁示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReentrantLockDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Phone</span> phone <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Phone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>phone<span class="token punctuation">,</span> <span class="token string">&quot;t1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>phone<span class="token punctuation">,</span> <span class="token string">&quot;t2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">Phone</span> <span class="token keyword">implements</span> <span class="token class-name">Runnable</span> <span class="token punctuation">{</span>
    <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; set lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; get lock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Synchronized可重入锁示例：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReentrantLockDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">lock1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">lock1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;lock1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">lock2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">synchronized</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">lock2</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;lock2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_5-3-自旋锁"><a href="#_5-3-自旋锁" class="header-anchor">#</a> 5.3 自旋锁</h3> <p>指尝试获取锁的线程，在未获取到锁时，不会立即阻塞，而是采用循环的方式去尝试获取锁，这样的好处是减少了线程上下文切换的消耗，缺点是循环获取锁会消耗CPU。在CAS中，UnSafe类中的getAndAddInt方法就是采用的这种方式来更新值。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicReference</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpinLockDemo</span> <span class="token punctuation">{</span>
    <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Thread</span><span class="token punctuation">&gt;</span></span> atomicReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpinLockDemo</span> spinLockDemo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SpinLockDemo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            spinLockDemo<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            spinLockDemo<span class="token punctuation">.</span><span class="token function">unLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Thread1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            spinLockDemo<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            spinLockDemo<span class="token punctuation">.</span><span class="token function">unLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Thread2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>thread<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; come in&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Thread</span> thread1 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>thread1<span class="token punctuation">,</span> thread<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            thread1 <span class="token operator">=</span> atomicReference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>thread<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; lock success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span> thread <span class="token operator">=</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>thread<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; unlock&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        atomicReference<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span>thread<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>thread<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; unlock success&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_5-4-独占锁、共享锁、互斥锁"><a href="#_5-4-独占锁、共享锁、互斥锁" class="header-anchor">#</a> 5.4 独占锁、共享锁、互斥锁</h3> <p>独占锁（写锁）：指该锁一次只能被一个线程所持有，对ReentrantLock和Synchronized而言，都是独占锁</p> <p>共享锁（读锁）：指该锁可以被多个线程所持有</p> <p>对ReentrantReadWriteLock，其读锁是共享锁，其写锁是独占锁</p> <p>读锁（共享锁）能够保证高并发读是非常高效的，但是读写、写读、写写的过程都是互斥的。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">HashMap</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span>UUID<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Lock</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ReadWriteLockDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MyCache</span> myCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">30</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> finalI <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> myCache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>finalI<span class="token punctuation">)</span><span class="token punctuation">,</span> UUID<span class="token punctuation">.</span><span class="token function">randomUUID</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Thread&quot;</span> <span class="token operator">+</span> finalI<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">30</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> finalI <span class="token operator">=</span> i<span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> myCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>finalI<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;Thread&quot;</span> <span class="token operator">+</span> finalI<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MyCache</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Lock</span> readLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">readLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Lock</span> writeLock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantReadWriteLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 由于在写入数据之前添加了写锁，所以一次只能有一个线程执行写操作
     * @param key
     * @param value
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; is writing, the key is: &quot;</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        writeLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            writeLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; has written successfully&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 在获取数据之前，添加读锁。由于读锁是共享锁，多个线程可以同时获取数据
     * @param key
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; is getting, the key is: &quot;</span> <span class="token operator">+</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        readLock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">Object</span> value <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; has read, the value is: &quot;</span> <span class="token operator">+</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            readLock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="六、线程通信"><a href="#六、线程通信" class="header-anchor">#</a> 六、线程通信</h2> <h3 id="_6-1-countdownlatch"><a href="#_6-1-countdownlatch" class="header-anchor">#</a> 6.1 CountDownLatch</h3> <p>让一些线程阻塞，直到另一些线程完成一系列操作后才被唤醒。</p> <p>CountDownLatch主要有两个方法，当一个或多个线程调用await方法时，调用的线程会被阻塞。其他线程调用countDown方法会将计数器减一（调用countDown方法的线程不会阻塞），当计数器的值变为零时，因调用await方法被阻塞的线程会被唤醒，继续执行。</p> <p>CountDownLatch是一个计数的锁，在构造函数中指定计数的初始值。之后通过调用countDownLatch()方法，来此值减少。当值减为0时，会唤醒之前由于await()方法被挂起的线程。可以用于一个任务需要在其他多个任务执行之后执行的场景。CountDownLatch中计数的值不能重置。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">CountDownLatch</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CountDownLatchDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">closeDoor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">closeDoor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 初始化数据量为10</span>
        <span class="token class-name">CountDownLatch</span> countDownLatch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDownLatch</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; leave.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 不断减少数量</span>
                countDownLatch<span class="token punctuation">.</span><span class="token function">countDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 当countDownLatch中的count大于0时，就会一直等待</span>
            countDownLatch<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; close the door.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-2-cyclicbarrier"><a href="#_6-2-cyclicbarrier" class="header-anchor">#</a> 6.2 CyclicBarrier</h3> <p>CyclicBarrier的字面意思是可循环使用的屏障。主要功能是：让一组线程到达一个屏障（同步点）时被阻塞，直到最后一个线程到达屏障时，屏障才会被打开，所有被屏障拦截的线程才会继续运行，线程进入屏障时通过CyclicBarrier的await()方法。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CyclicBarrierDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">CyclicBarrier</span> cyclicBarrier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CyclicBarrier</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;call。。。&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; has collected.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    cyclicBarrier<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> <span class="token operator">|</span> <span class="token class-name">BrokenBarrierException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_6-3-semaphore"><a href="#_6-3-semaphore" class="header-anchor">#</a> 6.3 Semaphore</h3> <p>信号量，主要用于</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Random</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">Semaphore</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SemaphoreDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Semaphore</span> semaphore <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Semaphore</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    semaphore<span class="token punctuation">.</span><span class="token function">acquire</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">int</span> time <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
                    <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;抢到车位，停车&quot;</span> <span class="token operator">+</span> time <span class="token operator">+</span> <span class="token string">&quot;秒&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                    semaphore<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">activeCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token keyword">yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;耗时：&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span>end <span class="token operator">-</span> start<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="七、阻塞队列"><a href="#七、阻塞队列" class="header-anchor">#</a> 七、阻塞队列</h2> <h3 id="_7-1-阻塞队列介绍"><a href="#_7-1-阻塞队列介绍" class="header-anchor">#</a> 7.1 阻塞队列介绍</h3> <p><a data-fancybox="" title="img" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/0ca79187feba447b84de8a2f09466477.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/0ca79187feba447b84de8a2f09466477.png" alt="img"></a></p> <p>线程1向阻塞队列中添加元素，线程2从阻塞队列中移除元素</p> <ul><li>当阻塞队列为空时，从队列中获取元素的操作将会被阻塞</li> <li>当阻塞队列为满时，向队列中插入元素的操作将会被阻塞</li> <li>试图从空的阻塞队列中获取元素的线程将会被阻塞，直到其他的线程往空的队列插入新的元素</li> <li>试图往已满的阻塞队列中添加新元素的线程也会被阻塞，直到其他的线程从列表中移除一个或多个元素或者完全清空队列后，使队列变得空闲起来，再新增</li></ul> <p>在多线程领域，所谓阻塞，就是在某些情况下，线程会被挂起，一旦条件满足，被挂起的线程又会被自动唤醒。</p> <p>在concurrent包发布以前，在多线程环境下，我们每个程序员都必须控制线程的挂起与唤醒，还要兼顾效率与线程安全，这给加大了程序的复杂度。而Blocking把这些底层的细节都完成了。</p> <p><a data-fancybox="" title="img" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/82569a287a13416685ae8e2547566d84.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/82569a287a13416685ae8e2547566d84.png" alt="img"></a></p> <p><a data-fancybox="" title="img" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/5b5c8113f2f548148b224dbebd5f828b.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/5b5c8113f2f548148b224dbebd5f828b.png" alt="img"></a></p> <h3 id="_7-2-常见阻塞队列"><a href="#_7-2-常见阻塞队列" class="header-anchor">#</a> 7.2 常见阻塞队列</h3> <p><a data-fancybox="" title="img" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/171e296e744a4ddb83072ae01a2f4885.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/171e296e744a4ddb83072ae01a2f4885.png" alt="img"></a></p> <ol><li><p>ArrayBlockingQueue：由数组结构组成的有界阻塞队列</p></li> <li><p>LinkedBlockingQueue：由链表结构组成的有界（大小默认值是Integer.MAX_VALUE）</p></li> <li><p>PriorityBlockingQueue: 支持优先级排序的无界阻塞队列</p></li> <li><p>DelayQueue：使用优先级队列实现的延迟无界阻塞队列</p></li> <li><p>SynchronousQueue：不存储元素的阻塞队列，也即单个元素的队列</p> <p>SynchronousQueue没有容量，与其他BlockingQueue不同，SynchronousQueue是一个不存储元素的BlockingQueue。</p> <p>每一个put操作必须等待一个take操作，否则不能继续添加元素，反之亦然。</p></li> <li><p>LinkedTransferQueue：由链表结构组成额无界阻塞队列</p></li> <li><p>LinkedBlockingDeque：由链表组成的双端阻塞队列</p></li></ol> <h3 id="_7-3-使用场景"><a href="#_7-3-使用场景" class="header-anchor">#</a> 7.3 使用场景</h3> <p>阻塞队列在线程池与消息中间件中有使用</p> <ol><li><p>生产者消费者模式（传统版）</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Condition</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Lock</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">ReentrantLock</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ProducerConsumerTraditionDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ShareData</span> shareData <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShareData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                shareData<span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Producer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                shareData<span class="token punctuation">.</span><span class="token function">decrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Consumer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">ShareData</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> number <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Lock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Condition</span> condition <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>number <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                condition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            number<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
            condition<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">decrement</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>number <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                condition<span class="token punctuation">.</span><span class="token function">await</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            number<span class="token operator">--</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; &quot;</span> <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
            condition<span class="token punctuation">.</span><span class="token function">signalAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>生产者消费者模式（阻塞队列）</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">BlockingQueue</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">SynchronousQueue</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>atomic<span class="token punctuation">.</span></span><span class="token class-name">AtomicInteger</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SynchronousQueueDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MyResource</span> myResource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyResource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SynchronousQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                myResource<span class="token punctuation">.</span><span class="token function">producer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Producer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                myResource<span class="token punctuation">.</span><span class="token function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;Consumer&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">MyResource</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">AtomicInteger</span> number <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> blockingQueue<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">MyResource</span><span class="token punctuation">(</span><span class="token class-name">BlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> blockingQueue<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>blockingQueue <span class="token operator">=</span> blockingQueue<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">producer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">boolean</span> result <span class="token operator">=</span> blockingQueue<span class="token punctuation">.</span><span class="token function">offer</span><span class="token punctuation">(</span>number<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;producer success &quot;</span> <span class="token operator">+</span> number<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;producer failure&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">consumer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Integer</span> poll <span class="token operator">=</span> blockingQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>poll <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;consumer failure&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;consumer success &quot;</span> <span class="token operator">+</span> number<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h2 id="八、线程池"><a href="#八、线程池" class="header-anchor">#</a> 八、线程池</h2> <h3 id="_8-1-线程池介绍"><a href="#_8-1-线程池介绍" class="header-anchor">#</a> 8.1 线程池介绍</h3> <p>线程池的主要工作是控制运行的线程数量，处理过程中将任务放入队列，然后线程从任务队列中获取任务并处理。主要特点是：线程复用，控制最大并发数，管理线程。</p> <p>优点：</p> <ol><li>降低资源消耗：通过重复利用已经创建的线程来降低创建和销毁线程带来的消耗。</li> <li>提高响应速度：当任务到达时，如果线程池中有空闲的线程，就能够立即执行，省去了创建线程的资源消耗</li> <li>提高线程的可管理性：线程是稀缺资源，如果无限制的创建，不仅会消耗系统资源，还会降低系统的稳定性，使用线程池进行统一的分配，调优和监控。</li></ol> <h3 id="_8-2-线程池的使用方法"><a href="#_8-2-线程池的使用方法" class="header-anchor">#</a> 8.2 线程池的使用方法</h3> <p>java中的线程池架构</p> <p><a data-fancybox="" title="img" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/9fdc0fe8acf04a82880865a9ec2c6871.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/9fdc0fe8acf04a82880865a9ec2c6871.png" alt="img"></a></p> <p>实现：</p> <ol><li><p>Executors.newScheduledThreadPool()</p></li> <li><p>Executors.newFixedThreadPool(int)</p> <p><a data-fancybox="" title="image-20200802175250788" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/4c0fe3f4dda7426b829e4c73e25e6d78.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/4c0fe3f4dda7426b829e4c73e25e6d78.png" alt="image-20200802175250788"></a></p> <p>创建一个定长的线程池，可以控制线程最大并发数量，超出的线程会在队列中等待。</p> <p>newFixedThreadPool创建的线程池，其corePoolSize与maximumPoolSize的值相等。使用的阻塞队列是LinkedBlockingQueue，其最大值为Integer.MAX_VALUE。</p></li> <li><p>Executors.newSingleThreadExecutor()</p> <p><a data-fancybox="" title="image-20200802180016281" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/28fbec54dc6c4dec8ada1ebce9e343bc.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/28fbec54dc6c4dec8ada1ebce9e343bc.png" alt="image-20200802180016281"></a></p> <p>创建一个单线程的线程池，它只会用唯一的工作线程来执行任务，保证所有任务都按指定顺序执行。</p> <p>newSingleThreadExecutor将corePoolSize与maximumPoolSize的值都设置为1，使用的阻塞队列是LinkedBlockingQueue，其最大值为Integer.MAX_VALUE。</p></li> <li><p>executors.newCachedThreadPool()</p> <p><a data-fancybox="" title="image-20200802180226542" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/63ee9bd29af5454f89e08c247e4b0ed9.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/63ee9bd29af5454f89e08c247e4b0ed9.png" alt="image-20200802180226542"></a></p> <p>创建一个可缓存的线程池，如果线程池长度超过处理需要，可以灵活回收空闲线程，若没有可回收的线程，则创建新的线程。</p> <p>newCachedThreadPool将corePoolSize设置为0，将maximumPoolSize设置为Integer.MAX_VALUE，使用的阻塞队列是SynchronousQueue，线程过期时间时60秒。CacheThreadPool在任务到达的时候，就创建线程运行，当线程空闲超过60秒，就销毁线程。</p></li> <li><p>Executors.newWorkStealingPool(int)</p> <p>java8新增的创建线程池方法，使用目前机器上可用的处理器作为它的并行级别</p></li></ol> <h3 id="_8-3-线程池的7个参数"><a href="#_8-3-线程池的7个参数" class="header-anchor">#</a> 8.3 线程池的7个参数</h3> <ol><li>int corePoolSize：线程池中的常驻核心线程数
<ol><li>在创建了线程池后，当有请求任务来之后，就会安排池中的线程去执行请求任务。</li> <li>当线程池中的线程数目达到corePoolSize后，就会把到达的任务放到缓存队列当中</li></ol></li> <li>int maximumPoolSize：线程池能够容纳同时执行的最大线程数，此值必须大于等于1</li> <li>long keepAliveTime：多余线程的存活时间。当前线程池数量超过corePoolSize时，当空闲时间达到keepAliveTime值时，多余空闲线程会被销毁直到只剩下corePoolSize个线程为止</li> <li>TimeUnit unit：keepAliveTime的单位</li> <li>BlockingQueue<Runnable> workQueue：任务队列，被提交但尚未被执行的任务</Runnable></li> <li>ThreadFactory threadFactory：表示生成线程池中工作线程的线程工厂，用于创建线程，一般用默认的</li> <li>RejectedExecutionHandler handler：拒绝策略，表示当队列满了并且工作线程大于等于线程池的最大线程数（maxPoolSize）时</li></ol> <h3 id="_8-4-线程池的底层工作原理"><a href="#_8-4-线程池的底层工作原理" class="header-anchor">#</a> 8.4 线程池的底层工作原理</h3> <p><a data-fancybox="" title="img" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/b18183df6087499d89842311a54d5987.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/b18183df6087499d89842311a54d5987.png" alt="img"></a></p> <p><a data-fancybox="" title="img" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/659e7946c56342ec8ff3eade7aebf892.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/659e7946c56342ec8ff3eade7aebf892.png" alt="img"></a></p> <ol><li>在创建线程池后，线程池中的线程就会等待提交的任务请求</li> <li>当调用execute()方法添加一个请求任务时，线程池会做如下判断：
<ol><li>如果正在运行的线程数量小于coolPoolSize，会立即创建线程执行任务</li> <li>如果正在运行的线程数量等于或大于corePoolSize，这个任务将会被放入等待队列</li> <li>如果这个时候队列满了且正在运行的线程数量还小于maximumPoolSize，会立即创建非核心线程并执行任务</li> <li>如果等待队列满了且正在运行的线程数量等于或大于maximumPoolSize，线程池会启动饱和拒绝策略来执行</li></ol></li> <li>当一个线程完成任务时，它会从等待队列中获取下一个任务来执行</li> <li>当一个线程无事可做并且空闲的时间超过了keepAliveTime，线程池会做如下判断：
<ol><li>如果当前运行的线程数量大于corePoolSize，这个线程将会被停掉</li> <li>如果当前运行的线程数量小于corePoolSize，这个线程会被保留</li> <li>线程池完成所有的任务后，线程池中线程的数量将会维持在corePoolSize</li></ol></li></ol> <h3 id="_8-5-线程池的拒绝策略"><a href="#_8-5-线程池的拒绝策略" class="header-anchor">#</a> 8.5 线程池的拒绝策略</h3> <p>当等待队列已经满了，并且线程池已经达到了maxPoolSize时，已经无法向新任务提供服务。此时，需要采用拒绝策略合理处理这个问题。</p> <p>JDK内置的拒绝策略：以下策略都实现了RejectedExecutionHandler接口</p> <ol><li>AbortPolicy(默认)：直接抛出RejectedExecutionException异常阻止系统正常运行</li> <li>CallerRunsPolicy：“调用者运行”一种调节机制，该策略既不会抛出任务，也不会抛出异常，而是将某些任务回退到调用者，从而降低新任务的流量</li> <li>DiscardOldestPolicy：抛出队列中等待最久的任务，然后把当前任务加入队列中尝试再次提交</li> <li>Discard：直接丢弃任务，不予任何处理也不抛出异常。如果允许任务丢失，这是最好的</li></ol> <h3 id="_8-6-如何创建线程池"><a href="#_8-6-如何创建线程池" class="header-anchor">#</a> 8.6 如何创建线程池</h3> <p>在《JAVA开发手册》中对使用线程池有以下说明：</p> <ol><li><p>线程资源必须通过线程池提供，不允许在应用中自行显式创建线程。</p> <p>说明：使用线程池的好处是减少在创建和销毁线程上所消耗的时间以及系统资源的开销，解决资源不足的问题。如果不实用线程池，有可能造成系统创建大量同类线程而导致消耗完内存或者“过度切换”的问题。</p></li> <li><p>线程池不允许使用Executors去创建，而是通过ThreadPoolExecutor的方式，这样的处理方式让写的同学更加明确线程池的运行规则，规避资源耗尽的风险。</p> <p>说明：Executors返回的线程池对象的弊端如下：</p> <ol><li><p>FixedThreadPool和SingleThreadPool：</p> <p>允许的请求队列长度为Integer.MAX_VALUE，可能会堆积大量的请求，从而导致OOM</p></li> <li><p>CachedThreadPool和ScheduledThreadPool：</p> <p>允许的创建线程数量为Integer.MAX_VALUE，可能会创建大量的线程，从而导致OOM</p></li></ol></li></ol> <p>一般情况下，不使用JDK自带的线程池，常见的四种线程池都存在OOM风险。</p> <p>自定义线程池：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ExecutorService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">LinkedBlockingDeque</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyThreadPoolDemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ExecutorService</span> executorService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingDeque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> finalI <span class="token operator">=</span> i<span class="token punctuation">;</span>
            executorService<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; work&quot;</span> <span class="token operator">+</span> finalI<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_8-7-合理配置线程池"><a href="#_8-7-合理配置线程池" class="header-anchor">#</a> 8.7 合理配置线程池</h3> <p>CPU密集型：此类任务，需要大量的运算，没有阻塞，CPU会一直全速运行。对于单核CPU，无论是单线程还是多线程，效果一样；对于多核CPU，线程池中线程的数量为：CPU核数+1</p> <p>IO密集型：此类任务，大多数时候，都是在处理IO，而CPU会空闲。因此，可以多开线程数，让CPU尽可能工作。线程数=CPU核数*2 或者 线程数=CPU核数/(1 - 阻塞系数)，阻塞系数在0.8~0.9之间。</p> <h2 id="九、死锁编码与定位分析"><a href="#九、死锁编码与定位分析" class="header-anchor">#</a> 九、死锁编码与定位分析</h2> <p>死锁是指两个或两个以上的进程在执行过程中，因争夺资源而造成的一种相互等待的现象，若无外力干涉，它们都将无法推进下去，如果系统资源充足，进程的资源请求都能够得到满足，死锁出现的可能性就很低，否则就会因争夺有限的资源产生死锁。</p> <p><a data-fancybox="" title="image-20200802212655602" href="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/cf9f4c2f484842d78b2273434c87542b.png"><img src="http://you-blog.oss-accelerate.aliyuncs.com/typora/2020-08-02/cf9f4c2f484842d78b2273434c87542b.png" alt="image-20200802212655602"></a></p> <p>排查死锁的方法：</p> <ol><li>jps命令定位进程号：jps -l</li> <li>jstack找到死锁：jstack pid</li></ol> <h2 id="十、synchronized与lock的区别"><a href="#十、synchronized与lock的区别" class="header-anchor">#</a> 十、Synchronized与Lock的区别</h2> <ol><li><p>原始构成</p> <p>Synchronized是关键字，属于JVM层面，monitorenter（底层是通过monitor对象来完成，其实wait与notify等方法也依赖于monitor对象，只有在同步块或同步方法中才能调用wait或notify等方法）</p> <p>Lock是具体类（java.util.concurrent.locks.Lock），是API层面的锁</p></li> <li><p>使用方法</p> <p>Synchronized 不需要用户手动释放锁，当Synchronized代码执行完毕后，系统会自行让线程释放对象的占用。</p> <p>ReentrantLock 则需要用户手动释放锁，若没有主动释放锁，就有可能出现死锁。在加锁与释放锁的时候，需要配合try…finally语句来完成。</p></li> <li><p>等待、是否可中断</p> <p>Synchronized 不可中断，释放锁一般是程序抛出异常或程序正常运行完毕</p> <p>ReentrantLock 可中断：</p> <ol><li>设置超时：tryLock(long time, TimeUnit unit)</li> <li>调用中断方法：lockInterruptibly()</li></ol></li> <li><p>加锁、是否公平</p> <p>Synchronized是非公平锁</p> <p>ReentrantLock两者都可以，默认是非公平锁，可以通过构造方法指定其类型</p></li> <li><p>锁绑定多个条件（Condition）</p> <p>Synchronized不能绑定条件，只能随机唤醒一个线程或者唤醒所有的线程</p> <p>ReentrantLock可以使用Condition来实现精准唤醒（一个或一组线程）</p></li></ol></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/01_多线程基础.html" class="prev">
        多线程
      </a></span> <span class="next"><a href="/blog_publish/java/01_ProgrammingBasic/01_JavaLanguage/03_Thread/03_Volatile关键字.html">
        Volatile关键字
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/blog_publish/assets/js/app.8eb0dca0.js" defer></script><script src="/blog_publish/assets/js/2.76e52daf.js" defer></script><script src="/blog_publish/assets/js/30.694d59ca.js" defer></script>
  </body>
</html>
